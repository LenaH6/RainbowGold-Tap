<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RainbowGold Tap</title>

  <!-- WalletConnect + wagmi (SOLO World App) -->
  <script src="https://unpkg.com/viem@2/dist/viem.min.js"></script>
  <script src="https://unpkg.com/@wagmi/core@2/dist/wagmi-core.min.js"></script>
  <script src="https://unpkg.com/@web3modal/wagmi@5/dist/index.umd.js"></script>
  <!-- MiniKit Pay (consulta doc oficial para bundlers) -->
  <script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit/dist/browser.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    #login-screen { display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; min-height:100vh; padding:24px; }
    #game-screen { display:none; padding: 0; }
    .btn { padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer; border:0; }
    .btn-primary { background:#111; color:#fff; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #e5e5e5; border-radius:14px; padding:12px 14px; }
  </style>

</head>
<body>

  <div id="login-screen" class="card">
    <h2>RainbowGold Tap</h2>
    <button id="siweBtn" style="display:none" class="btn btn-primary">Login con SIWE (World App)</button>
    <small>Solo World App (WalletConnect). No se permiten otras wallets.</small>
  </div>

  <div id="game-screen">
    <!-- AQU√ç VA TU JUEGO (HTML original) -->
    <div id="game-root">
<!-- === SPLASH / CARGA INICIAL === -->
<div id="splash" class="splash" aria-busy="true" aria-label="Cargando RainbowGold">
  <div class="splash__logo">
    <img src="img/logo-splash.png" alt="RainbowGold" data-critical fetchpriority="high" decoding="async">

  </div>

  <button id="wldSignIn" data-i18n="signin_wld"
  style="margin-top:18px;padding:12px 16px;border-radius:12px;
         background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
         color:#fff;font-weight:700;cursor:pointer">
  Entrar con World ID
</button>


 <div id="wldState" class="splash__hint" style="margin-top:10px;opacity:1;transform:translateY(0)">
  <span data-i18n="preparing_session">Preparando tu sesi√≥n</span>
  <span class="dots"><span>.</span><span>.</span><span>.</span></span>
</div>



</div>

<!-- Left FABs -->
<div class="floatCol">
  <button id="profileBtn" class="fab profile" title="Profile">
    <img src="img/icon-profile.png" alt="Perfil" style="width:45px;height:45px;">
  </button>
  <button id="inboxBtn" class="fab inbox" title="Inbox">
    <img src="img/icon-inbox.png" alt="Inbox" style="width:35px;height:35px;">
    <span id="inboxBadge" class="badge" style="display:none">0</span>
  </button>
</div>

<!-- Topbar -->
<div class="topbar">
  <h1 class="logo-text"></h1>
  <!-- Aviso p√∫blico centrado ARRIBA (donde estaba el logo) -->
  <div id="activityBar" class="activity-bar" aria-live="polite"></div>
</div>




<!-- Bot√≥n trofeo en top-actions -->
<div class="top-actions" style="overflow:visible">
  <div><span data-i18n="wld_balance">Saldo WLD:</span></div>
  <div><b id="balWLD">0.00</b> WLD</div>

  <!-- WRAP del trofeo: el tip vive junto al bot√≥n -->
  <div class="trophyWrap">
    <button id="trophyBtn" class="fab trophy" title="Leaderboard" type="button" aria-describedby="trophyTip">
      <img src="img/icon-trophy.png" alt="Trophy" style="width:25px;height:25px;">
    </button>
    <div id="trophyTip" class="tip" data-i18n="coming_soon">Pr√≥ximamente</div>
  </div>
  </div>

<!-- HERO -->
<section class="hero">
  <!-- Pastilla de RBGp: SOLO esto adentro -->
  <div class="pill">
    <img src="img/brand-mark-wg-128.png" alt="" onerror="this.style.display='none'">
    RBGp: <b id="balRBGp" aria-live="polite">0.000</b>
  </div>

  <!-- Moneda (coin) ‚Äî YA NO va dentro de .pill -->
  <div class="coinWrap" id="coinBox">
    <div class="ring"></div>
    <canvas id="fx"></canvas>

    <div id="coin" class="coin" aria-label="Tap">
      <svg id="windowArc" viewBox="0 0 100 100" style="position:absolute;inset:0;width:100%;height:100%;opacity:0;pointer-events:none;transform:rotate(-90deg);z-index:6">
        <defs>
          <linearGradient id="frenzy777" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="#ff0055"/>
            <stop offset="20%"  stop-color="#ff9500"/>
            <stop offset="40%"  stop-color="#ffee00"/>
            <stop offset="60%"  stop-color="#33dd55"/>
            <stop offset="80%"  stop-color="#33aaff"/>
            <stop offset="100%" stop-color="#aa66ff"/>
          </linearGradient>
        <!-- ‚≠ê Gradiente radial para el aro (m√°s intenso) -->
  <radialGradient id="haloArc" cx="50%" cy="50%" r="65%">
    <stop offset="0%"   stop-color="#ffffff" stop-opacity="1"/>
    <stop offset="35%"  stop-color="#FFD872" stop-opacity="1"/>
    <stop offset="70%"  stop-color="#cfae45" stop-opacity="0.8"/>
    <stop offset="100%" stop-color="#000000" stop-opacity="0"/>
  </radialGradient>

  <!-- ‚≠ê Filtro de glow n√≠tido (no lava el color) -->
  <filter id="arcGlow" x="-60%" y="-60%" width="220%" height="220%">
    <feGaussianBlur in="SourceGraphic" stdDeviation="2.2" result="blur"/>
    <feMerge>
      <feMergeNode in="blur"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
        </defs>
        <circle cx="50" cy="50" r="46" fill="none" stroke="#ffd872" stroke-width="4" stroke-linecap="round" pathLength="360"></circle>
      </svg>

      <div id="windowTag"
  style="position:absolute;top:8px;right:10px;
         transform:none;
         padding:4px 10px;font-weight:800;font-size:12px;
         line-height:1;border-radius:12px;
         border:1px solid rgba(255,255,255,.18);
         background:rgba(0,0,0,.70);color:#ffd872;
         opacity:0;transition:opacity .14s,transform .18s;
         pointer-events:none;z-index:999"></div>


      <img src="img/Coin.png" alt="" class="coinImg" onerror="this.remove();document.getElementById('fallback').style.display='block'">
      <div id="fallback" class="coinFallback" style="display:none">ü™ô</div>

      <div id="gain"
        style="position:absolute; left:0; top:0;
               font-size:14px; font-weight:900; color:#fff;
               text-shadow:0 2px 6px rgba(0,0,0,.55), 0 0 10px rgba(0,0,0,.35);
               pointer-events:none; z-index:1001;">
      </div>

      <div id="hot" style="
        position:absolute; inset:0;
        pointer-events:none; opacity:0; transition:opacity .18s ease;
        filter: drop-shadow(0 0 10px rgba(255,223,120,.25));
      "></div>

      <div id="hotCore" style="
        position:absolute; left:50%; top:50%;
        transform:translate(-50%,-50%);
        width:0; height:0; border-radius:50%;
        pointer-events:none; opacity:0;
        box-shadow: 0 0 6px rgba(0,0,0,.25) inset, 0 0 6px rgba(255,255,255,.15);
      "></div>



<div id="comboBadge" style="
  position:absolute; top:10px; left:10px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18);
  color:#ffd872; font-weight:800; font-size:12px;
  padding:4px 8px; border-radius:10px; display:none; pointer-events:none;">
  <span id="comboTxt">COMBO x1</span>
</div>



    <!-- Bot√≥n Ideas anclado a la moneda -->
    <button id="ideasBtn" class="idea-btn" aria-label="Ideas">
      <img src="img/icon-idea.png" alt="Ideas" onerror="this.style.display='none'">
    </button>
  </div>

  <!-- DOCK bajo la moneda -->
  <div class="action-dock" aria-label="acciones r√°pidas">
    <button id="refillBtn" class="btn-icon" aria-label="Refill">
      <img src="img/ico-refill.png" alt="Perfil" style="width:40px;height:40px;">
      <span id="refillPrice" class="price-pill">0.10 WLD</span>
    </button>
    <button id="openUp" class="btn-icon" aria-label="Boosters">
      <img src="img/icon-gear.png" alt="Perfil" style="width:40px;height:35px;">
    </button>
  </div>

  <div class="energyWrap">
    <div class="energyBar"><div id="energyFill" class="energyFill" style="width:100%"></div></div>
    <div class="energyLbl">‚ö° <b id="energyNow">100</b>/<b id="energyMax">100</b></div>
  </div>
</section>





<!-- Drawers (Boosters simple + Inbox placeholder+Perfil) -->
<div id="backdropUP" class="backdrop"></div>
<aside id="drawerUP" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('UP')">x</button>
  <div class="drawer-body">
    <h3 data-i18n="boosters_title">Impulsores</h3>
    <p style="opacity:.85" data-i18n="coming_soon">Proximamente... ‚úî</p>
  </div>
</aside>



<div id="backdropIN" class="backdrop"></div>
<aside id="drawerIN" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('IN')">x</button>
  <div class="drawer-body">
    <h3>üì• Buz√≥n</h3>
    <div id="inboxList" class="chatList"></div>
    <button id="markRead" class="btnPro">Marcar todo como le√≠do</button>
  </div>
</aside>

<!-- Drawer IDEAS -->
 <div id="backdropID" class="backdrop"></div>
<aside id="drawerID" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('ID')">x</button>
  <div class="drawer-body">
  <h3 data-i18n="ideas_title">Ideas</h3>


  <!-- Vista inicial: pagar -->
  <div id="ideasPayView" class="cardPro">
   <p data-i18n="ideas_pay_intro">¬°S√© parte de los desarrolladores y carrera con la comunidad PARTICIPA!</p>
  <button id="payIdeasBtn" class="btn-icon">
  <img src="img/icon-idea.png" alt="pagar" style="width:28px;height:28px;">
  <span data-i18n="ideas_pay_btn">Comprar ticket</span>
  <span class="price-pill"><b>1 WLD üéüÔ∏è</b></span>
</button>
</div>


  <!-- Vista desbloqueada: opciones -->
  <div id="ideasOptionsView" class="cardPro" style="display:none">
  <p><b data-i18n="ideas_choose">Escoge una opci√≥n</b></p>
  <p id="ticketTimer" style="margin:10px 0;font-size:14px;color:#ffd872;font-weight:bold">
  Tiempo restante: 05:00
  </p>
  <button id="voteBtn" class="btn-icon btnPro"><b data-i18n="vote">Votar‚úçÔ∏è</b></button>
  <button id="suggestBtn" class="btn-icon btnPro"><b data-i18n="suggest">Sugerenciaüí°</b></button>
  <p style="font-size:12px;opacity:.6;margin-top:6px">
  <i data-i18n="each_action_consumes">*Cada acci√≥n consume 1 ticket</i>
  </p>

  </div>
  <!-- Vista: Encuesta -->
<div id="ideasPollView" class="cardPro" style="display:none">
<h4 style="margin:6px 0 8px" data-i18n="poll_title">üèÅ ¬°EMPIEZA LA CARRERA!</h4>
<p class="hint"><b data-i18n="poll_hint">T√ö ELIGESüíä</b></p>


  <!-- Opciones -->
  <div style="display:grid; gap:8px; margin:10px 0 12px;">
    <button class="btn" id="pollOptA"><b data-i18n="opt_a">Comodidad/Seguridadüîµ</b></button>
<button class="btn" id="pollOptB"><b data-i18n="opt_b">Cambio/Riesgoüî¥</b></button>
<button class="btn" id="pollOptC"><b data-i18n="opt_c">Autotap ü§ñ</b></button>
</div>

  <!-- Resultados (barras simples) -->
  <div id="pollResults" style="display:none; margin-top:10px;">
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">A</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barA" style="height:100%;width:0;background:#c9a848"></div>
      </div>
      <span id="pctA" style="width:48px;text-align:right">0%</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">B</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barB" style="height:100%;width:0;background:#9aa0ff"></div>
      </div>
      <span id="pctB" style="width:48px;text-align:right">0%</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">C</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barC" style="height:100%;width:0;background:#78d59c"></div>
      </div>
      <span id="pctC" style="width:48px;text-align:right">0%</span>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-top:12px;">
   <button class="btn" id="pollClose" data-i18n="poll_close">Cerrar</button>
  </div>
</div>

<!-- Vista: Enviar sugerencia -->
<div id="ideasSuggestView" class="cardPro" style="display:none">
  <h4 style="margin:6px 0 8px" data-i18n="suggest_title">¬øAlguna idea?</h4>
<p class="hint"><b data-i18n="suggest_hint">M√°x. 400 caracteres.</b></p>
<textarea id="suggestText" class="textareaPro" rows="5" maxlength="240"
  data-i18n-placeholder="placeholder_suggest"
  placeholder="Escribe tu idea o mejora aqu√≠‚Ä¶" style="width:100%;"></textarea>

<button class="btn" id="sendSuggestBtn" data-i18n="send">Enviar</button>
<button class="btn" id="sugClose" data-i18n="close">Cerrar</button>

  </div>
</div>


</aside>


<div id="backdropPF" class="backdrop"></div>
<aside id="drawerPF" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('PF')">x</button>
  <div class="drawer-body">
  <h3 data-i18n="profile_title" style="margin:0 0 12px">Perfil</h3>
  <div class="cardPro">
<label data-i18n="username_label" style="display:block;margin-bottom:8px;font-size:14px;">Nombre de usuario</label>
<input id="usernameInput"  class="inputPro" type="text"
  style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;"
  data-i18n-placeholder="username_placeholder"
  placeholder="Tu nombre">

<div id="saveRow" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
  <button id="saveUsernameBtn" class="btn-icon" style="min-height:auto;padding:6px 10px;display:none" data-i18n="save">Guardar</button>
  <small style="font-style: italic; color: gray;">
  M√°x. 3
</small>
  <span id="savedBadge" style="display:none;font-size:12px;color:#ffd872;">‚úì <span data-i18n="saved">Guardado</span></span>
</div>

<label data-i18n="language_label" style="display:block;margin:16px 0 8px;font-size:14px;">Idioma</label>
<select id="langSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;">
  <option value="es" data-i18n="option_es">Espa√±ol</option>
  <option value="en" data-i18n="option_en">Ingl√©s</option>
</select>

<div style="margin:16px 0;">
  <p><span data-i18n="profile_rbgp_label">RBGp:</span> <b id="profRBGp">0.000</b></p>
  <p style="opacity:.7;"><span data-i18n="profile_rbg_label">RBG Balance:</span> <b id="profRBG">--</b> üîí</p>
  <p style="opacity:.7;"><span data-i18n="profile_wld_label">WLD Balance:</span> <b id="profWLD">--</b> üîí</p>
</div>

<button id="claimBtn" class="btn-icon" disabled style="opacity:.5;" data-i18n="claim_soon">Reclamar (Pronto)</button>
</div>
<div class="legal-in-profile">
  <a class="legal-link" href="/terminos" target="_blank" rel="noopener">T√©rminos</a> ¬∑
  <a class="legal-link" href="/privacidad" target="_blank" rel="noopener">Privacidad</a>
</div>



</aside>











<script src="js/game-logic.js"></script>
<script src="js/payments.js"></script>
<script type="module" src="js/minikit-config.js"></script>
<script type="module" src="js/worldcoin-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js"></script>
<script>
(function(){
  if (window.__RG_bootstrap_lite) return; window.__RG_bootstrap_lite=true;

  // WLD.login simple
  window.WLD = window.WLD || {};
  window.WLD.login = function(){
    try{
      var base = location.origin + location.pathname + (location.hash || '#play');
      location.href = '/auth/login?returnTo=' + encodeURIComponent(base);
    }catch(_){ location.href='/auth/login'; }
  };

  // Enlazar bot√≥n si existe (una vez)
  document.addEventListener('DOMContentLoaded', function(){
    var b = document.getElementById('wldSignIn');
    if (b) b.addEventListener('click', function(){ if(window.WLD&&WLD.login) WLD.login(); }, { once:false });
  });

  // Enter game (try once)
  function enterGameOnce(){
    if (window.__RG_gate_done) return; window.__RG_gate_done = true;
    try { if (typeof setVerifiedUI === 'function') setVerifiedUI(true); } catch(_){}
    var fns=['startRainbowGold','startGame','initGame','beginGame','bootGame','start','main','gameStart'];
    for (var i=0;i<fns.length;i++){ try{ if (typeof window[fns[i]]==='function'){ window[fns[i]](); break; } }catch(_){ } }
    try{ var pb=document.querySelector('#play,#playBtn,.btn-play,[data-play]'); if(pb) pb.click(); }catch(_){}
    try{ var cv=document.querySelector('canvas'); if(cv){ cv.focus(); cv.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); } }catch(_){}
  }

  function isVerified(){
    try { if (new URLSearchParams(location.search).get('verified')==='1') return true; } catch(_){}
    try { if (localStorage.getItem('wld_verified')==='1') return true; } catch(_){}
    try { if (sessionStorage.getItem('wld_verified')==='1') return true; } catch(_){}
    return false;
  }
  function clearVerified(){
    try { localStorage.removeItem('wld_verified'); } catch(_){}
    try { sessionStorage.removeItem('wld_verified'); } catch(_){}
    try { document.cookie='wld_verified=; Max-Age=0; Path=/; SameSite=Lax'; } catch(_){}
    try { var u=new URL(location.href); if(u.searchParams.get('verified')==='1'){ u.searchParams.delete('verified'); history.replaceState(null,'',u.toString()); } }catch(_){}
  }

  // Touch‚ÜíMouse + Audio resume
  (function(){
    var resumed=false;
    function resumeAudio(){
      if(resumed) return; resumed=true;
      try{ if(window.audioCtx && typeof audioCtx.resume==='function') audioCtx.resume(); }catch(_){}
      try{ if(window.AudioContext){ var ctx=new AudioContext(); if (ctx.state==='suspended') ctx.resume(); } }catch(_){}
    }
    function mapTouchToMouse(el){
      function conv(type,t){ return new MouseEvent(type,{bubbles:true,cancelable:true,clientX:t.clientX,clientY:t.clientY}); }
      el.addEventListener('touchstart',function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mousedown',t)); resumeAudio(); },{passive:false});
      el.addEventListener('touchmove', function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mousemove',t)); },{passive:false});
      el.addEventListener('touchend',  function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mouseup',t));   },{passive:false});
    }
    document.addEventListener('DOMContentLoaded',function(){
      var c=document.querySelector('canvas'); if (c){ mapTouchToMouse(c); c.addEventListener('touchstart', resumeAudio, {passive:true}); }
      document.addEventListener('touchstart', resumeAudio, {once:true, passive:true});
    });
  })();

  // Auto: si venimos verificados -> entrar y limpiar marca
  document.addEventListener('DOMContentLoaded', function(){
    if (isVerified()) { enterGameOnce(); clearVerified(); }
  });
  window.addEventListener('message', function(ev){ if(ev&&ev.data&&ev.data.type==='wld:verified'){ enterGameOnce(); } });

})();
</script>
    </div>

    <!-- MiniKit Pay botones de ejemplo (puedes quitar si no los usas aqu√≠) -->
    <div style="padding:12px;">
      <div class="row">
        <button id="pay-refill" class="btn">Comprar Refill (0.1 WLD)</button>
        <button id="pay-idea" class="btn">Ticket de Ideas (1 WLD)</button>
      </div>
      <div id="status" style="margin-top:10px;"></div>
    </div>
  </div>


<script>
(async () => {
  const WC_PROJECT_ID = "ddfa618a5dda216e266d0659744df365";
  const API_BASE = "/api";

  const { createConfig, reconnect, getAccount, connect, getChainId, signMessage } = window.wagmiCore;
  const { defaultWagmiConfig, createWeb3Modal } = window.WEB3MODAL_WAGMI;
  const chains = [{ id: 8453, name: 'Base', nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, rpcUrls: { default: { http: ['https://mainnet.base.org'] } } }];

  const wagmiConfig = createConfig(defaultWagmiConfig({
    chains,
    projectId: WC_PROJECT_ID,
    enableInjected: false,
    enableWalletConnect: true,
    enableCoinbase: false
  }));
  createWeb3Modal({ wagmiConfig, projectId: WC_PROJECT_ID, themeMode: 'dark' });
  await reconnect(wagmiConfig);

  
    // === State machine to avoid splash/login loop ===
    window.__state = { loggedIn: false, gameStarted: false };
    const $ = (s) => document.querySelector(s);
    const loginScreen = $("#login-screen");
    const gameScreen  = $("#game-screen");
    const splash      = $("#splash");
    const wldBtn      = $("#wldSignIn");   // existing button
    const wldState    = $("#wldState");

    function setBusy(on){
      const btn = $("#wldSignIn") || $("#siweBtn");
      if (btn){ btn.disabled = !!on; btn.style.opacity = on ? "0.6":"1"; }
      if (wldState){ wldState.style.display = on ? "block" : "none"; }
    }

    function gotoLogin(){
      if (gameScreen) gameScreen.style.display = "none";
      if (loginScreen) loginScreen.style.display = "flex";
      if (splash) splash.style.display = "block";
      document.body.dataset.view = "login";
    }

    function gotoGame(){
      window.__state.loggedIn = true;
      if (loginScreen) loginScreen.style.display = "none";
      if (splash) splash.style.display = "none"; // ‚õî oculta splash en juego
      if (gameScreen) gameScreen.style.display = "block";
      document.body.dataset.view = "game";
      // Ocultar cualquier splash conocido
      try {
        const hideSplashEls = () => {
          const ids = ["splash", "loading", "loader", "preloader", "wldstate"];
          ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = "none"; });
          document.querySelectorAll(".splash,.splash_screen,.splash-container,.loading,.loader,.preloader").forEach(el => {
            el.style.display = "none";
            el.setAttribute("aria-busy","false");
          });
        };
        hideSplashEls();
      } catch(e){ console.warn("hideSplashEls error", e); }
      // Lanza el juego solo una vez
      if (!window.__state.gameStarted && window.__runGame){
        window.__state.gameStarted = true;
        try { window.__runGame(); } catch(e){ console.error("Game start error:", e); }
      }
    }
async function api(path, opts) {
    const res = await fetch(API_BASE + path, { credentials: "include", ...opts });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function ensureConnected() {
    const acc = getAccount(wagmiConfig);
    if (!acc.isConnected) {
      await connect(wagmiConfig, { connector: wagmiConfig.connectors[0] });
    }
    const a = getAccount(wagmiConfig);
    if (!a.address) throw new Error("No hay address de World App");
    return a.address;
  }

  async function loginSiwe() {
    const address = await ensureConnected();
    const { nonce } = await api("/nonce", { method: "GET" });

    const statement = "Iniciar sesi√≥n en RainbowGold Tap";
    const chainId = getChainId(wagmiConfig) || 1;
    const message = [
      `${address} quiere iniciar sesi√≥n`,
      ``,
      `URI: ${location.origin}`,
      `Version: 1`,
      `Chain ID: ${chainId}`,
      `Nonce: ${nonce}`,
      `Issued At: ${new Date().toISOString()}`,
      `Statement: ${statement}`
    ].join("\n");

    const signature = await signMessage(wagmiConfig, { message });
    const ver = await api("/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, signature })
    });
    if (ver.ok) {
      gotoGame();
      if (window.__runGame) { try { await window.__runGame(); } catch(e){ console.error(e); } }
    } else {
      throw new Error("Verificaci√≥n SIWE fall√≥");
    }
  }

  document.getElementById("siweBtn").addEventListener("click", () => {
    loginSiwe().catch(err => alert("Error SIWE: " + (err?.message || err)));
  });

  // Si ya hay sesi√≥n valida, entra directo
  try {
    const me = await api("/me", { method: "GET" });
    if (me.ok) {
      gotoGame();
      if (window.__runGame) { try { await window.__runGame(); } catch(e){ console.error(e); } }
    }
  } catch {};

  // MiniKit Pay helpers
  function ensureMiniKit() {
    if (!window.MiniKit) { throw new Error("MiniKit no disponible"); }
    return window.MiniKit;
  }

  async function payWLD(amountWLD, description) {
    await ensureConnected();
    const order = await api("/pay/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amountWLD, description })
    });
    if (!order.ok) throw new Error("No se pudo crear la orden");
    const MiniKit = ensureMiniKit();
    const payRes = await MiniKit.pay?.({
      amount: amountWLD,
      asset: "WLD",
      description,
      reference: order.orderId
    });
    if (payRes?.status === "success") {
      await api("/pay/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId: order.orderId, txHash: payRes.txHash || null })
      });
      return true;
    } else {
      throw new Error(payRes?.error || "Pago cancelado o fallido");
    }
  }

  const s = document.getElementById("status");
  const btnRefill = document.getElementById("pay-refill");
  const btnIdea = document.getElementById("pay-idea");
  if (btnRefill) btnRefill.addEventListener("click", async () => {
    if (s) s.textContent = "Procesando pago de refill...";
    try { await payWLD(0.1, "Refill de energ√≠a"); if (s) s.textContent = "Pago OK. Refill aplicado."; }
    catch (e) { if (s) s.textContent = "Pago fallido: " + (e?.message || e); }
  });
  if (btnIdea) btnIdea.addEventListener("click", async () => {
    if (s) s.textContent = "Procesando pago de ticket de ideas...";
    try { await payWLD(1, "Ticket de Ideas"); if (s) s.textContent = "Pago OK. Ticket otorgado."; }
    catch (e) { if (s) s.textContent = "Pago fallido: " + (e?.message || e); }
  });
})();
</script>
<script>
window.__runGame = async function(){

  await new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = "js/game-logic.js";
    el.async = false;
    el.onload = () => resolve();
    el.onerror = () => reject(new Error('No se pudo cargar ' + el.src));
    document.body.appendChild(el);
  });


  await new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = "js/payments.js";
    el.async = false;
    el.onload = () => resolve();
    el.onerror = () => reject(new Error('No se pudo cargar ' + el.src));
    document.body.appendChild(el);
  });


  await new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = "js/minikit-config.js";
    el.async = false;
    el.onload = () => resolve();
    el.onerror = () => reject(new Error('No se pudo cargar ' + el.src));
    document.body.appendChild(el);
  });


  await new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = "js/worldcoin-auth.js";
    el.async = false;
    el.onload = () => resolve();
    el.onerror = () => reject(new Error('No se pudo cargar ' + el.src));
    document.body.appendChild(el);
  });


  await new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js";
    el.async = false;
    el.onload = () => resolve();
    el.onerror = () => reject(new Error('No se pudo cargar ' + el.src));
    document.body.appendChild(el);
  });


  // Inline del juego
  try {
    (function(){
      if (window.__RG_bootstrap_lite) return; window.__RG_bootstrap_lite=true;
    
      // WLD.login simple
      window.WLD = window.WLD || {};
      window.WLD.login = function(){
        try{
          var base = location.origin + location.pathname + (location.hash || '#play');
          location.href = '/auth/login?returnTo=' + encodeURIComponent(base);
        }catch(_){ location.href='/auth/login'; }
      };
    
      // Enlazar bot√≥n si existe (una vez)
      document.addEventListener('DOMContentLoaded', function(){
        var b = document.getElementById('wldSignIn');
        if (b) b.addEventListener('click', function(){ if(window.WLD&&WLD.login) WLD.login(); }, { once:false });
      });
    
      // Enter game (try once)
      function enterGameOnce(){
        if (window.__RG_gate_done) return; window.__RG_gate_done = true;
        try { if (typeof setVerifiedUI === 'function') setVerifiedUI(true); } catch(_){}
        var fns=['startRainbowGold','startGame','initGame','beginGame','bootGame','start','main','gameStart'];
        for (var i=0;i<fns.length;i++){ try{ if (typeof window[fns[i]]==='function'){ window[fns[i]](); break; } }catch(_){ } }
        try{ var pb=document.querySelector('#play,#playBtn,.btn-play,[data-play]'); if(pb) pb.click(); }catch(_){}
        try{ var cv=document.querySelector('canvas'); if(cv){ cv.focus(); cv.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); } }catch(_){}
      }
    
      function isVerified(){
        try { if (new URLSearchParams(location.search).get('verified')==='1') return true; } catch(_){}
        try { if (localStorage.getItem('wld_verified')==='1') return true; } catch(_){}
        try { if (sessionStorage.getItem('wld_verified')==='1') return true; } catch(_){}
        return false;
      }
      function clearVerified(){
        try { localStorage.removeItem('wld_verified'); } catch(_){}
        try { sessionStorage.removeItem('wld_verified'); } catch(_){}
        try { document.cookie='wld_verified=; Max-Age=0; Path=/; SameSite=Lax'; } catch(_){}
        try { var u=new URL(location.href); if(u.searchParams.get('verified')==='1'){ u.searchParams.delete('verified'); history.replaceState(null,'',u.toString()); } }catch(_){}
      }
    
      // Touch‚ÜíMouse + Audio resume
      (function(){
        var resumed=false;
        function resumeAudio(){
          if(resumed) return; resumed=true;
          try{ if(window.audioCtx && typeof audioCtx.resume==='function') audioCtx.resume(); }catch(_){}
          try{ if(window.AudioContext){ var ctx=new AudioContext(); if (ctx.state==='suspended') ctx.resume(); } }catch(_){}
        }
        function mapTouchToMouse(el){
          function conv(type,t){ return new MouseEvent(type,{bubbles:true,cancelable:true,clientX:t.clientX,clientY:t.clientY}); }
          el.addEventListener('touchstart',function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mousedown',t)); resumeAudio(); },{passive:false});
          el.addEventListener('touchmove', function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mousemove',t)); },{passive:false});
          el.addEventListener('touchend',  function(e){ var t=e.changedTouches[0]; el.dispatchEvent(conv('mouseup',t));   },{passive:false});
        }
        document.addEventListener('DOMContentLoaded',function(){
          var c=document.querySelector('canvas'); if (c){ mapTouchToMouse(c); c.addEventListener('touchstart', resumeAudio, {passive:true}); }
          document.addEventListener('touchstart', resumeAudio, {once:true, passive:true});
        });
      })();
    
      // Auto: si venimos verificados -> entrar y limpiar marca
      document.addEventListener('DOMContentLoaded', function(){
        if (isVerified()) { enterGameOnce(); clearVerified(); }
      });
      window.addEventListener('message', function(ev){ if(ev&&ev.data&&ev.data.type==='wld:verified'){ enterGameOnce(); } });
    
    })();
  } catch(e) { console.error('Error en script del juego:', e); }
};

  // Guard: keep splash (and lookalikes) hidden once in game
  const mo = new MutationObserver(() => {
    if (document.body.dataset.view === "game") {
      const ids = ["splash", "loading", "loader", "preloader", "wldstate"];
      ids.forEach(id => { const el = document.getElementById(id); if (el && el.style.display !== "none") el.style.display = "none"; });
      document.querySelectorAll(".splash,.splash_screen,.splash-container,.loading,.loader,.preloader").forEach(el => {
        if (el.style.display !== "none") el.style.display = "none";
      });
    }
  });
  mo.observe(document.body, { attributes:true, childList:true, subtree:true });</script>

</body>
</html>