<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RainbowGold Tap</title>

  <!-- WalletConnect + wagmi (SOLO World App) -->
  <script src="https://unpkg.com/viem@2/dist/viem.min.js"></script>
  <script src="https://unpkg.com/@wagmi/core@2/dist/wagmi-core.min.js"></script>
  <script src="https://unpkg.com/@web3modal/wagmi@5/dist/index.umd.js"></script>
  <!-- MiniKit Pay (consulta doc oficial para bundlers) -->
  <script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit/dist/browser.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    #login-screen { display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; min-height:100vh; padding:24px; }
    #game-screen { display:none; padding: 0; }
    .btn { padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer; border:0; }
    .btn-primary { background:#111; color:#fff; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #e5e5e5; border-radius:14px; padding:12px 14px; }
  </style>
  <link rel="stylesheet" href="css/styles.css">

    <script src="https://unpkg.com/@wagmi/connectors@4.3.1/dist/wagmi-connectors.umd.js"></script>
</head>
<body>
<!-- === SPLASH / CARGA INICIAL === -->
<div id="splash" class="splash" aria-busy="true" aria-label="Cargando RainbowGold">
  <div class="splash__logo">
    <img src="img/logo-splash.png" alt="RainbowGold" data-critical fetchpriority="high" decoding="async">

  </div>

  <button id="wldSignIn" data-i18n="signin_wld"
  style="margin-top:18px;padding:12px 16px;border-radius:12px;
         background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
         color:#fff;font-weight:700;cursor:pointer">
  Entrar con World ID
</button>


 <div id="wldState" class="splash__hint" style="margin-top:10px;opacity:1;transform:translateY(0)">
  <span data-i18n="preparing_session">Preparando tu sesiÃ³n</span>
  <span class="dots"><span>.</span><span>.</span><span>.</span></span>
</div>
</div> <!-- /#splash -->

<div id="game-screen" style="display:none">
    <div id="game-root">

<!-- Left FABs -->
<div class="floatCol">
  <button id="profileBtn" class="fab profile" title="Profile">
    <img src="img/icon-profile.png" alt="Perfil" style="width:45px;height:45px;">
  </button>
  <button id="inboxBtn" class="fab inbox" title="Inbox">
    <img src="img/icon-inbox.png" alt="Inbox" style="width:35px;height:35px;">
    <span id="inboxBadge" class="badge" style="display:none">0</span>
  </button>
</div>

<!-- Topbar -->
<div class="topbar">
  <h1 class="logo-text"></h1>
  <!-- Aviso pÃºblico centrado ARRIBA (donde estaba el logo) -->
  <div id="activityBar" class="activity-bar" aria-live="polite"></div>
</div>




<!-- BotÃ³n trofeo en top-actions -->
<div class="top-actions" style="overflow:visible">
  <div><span data-i18n="wld_balance">Saldo WLD:</span></div>
  <div><b id="balWLD">0.00</b> WLD</div>

  <!-- WRAP del trofeo: el tip vive junto al botÃ³n -->
  <div class="trophyWrap">
    <button id="trophyBtn" class="fab trophy" title="Leaderboard" type="button" aria-describedby="trophyTip">
      <img src="img/icon-trophy.png" alt="Trophy" style="width:25px;height:25px;">
    </button>
    <div id="trophyTip" class="tip" data-i18n="coming_soon">PrÃ³ximamente</div>
  </div>
  </div>

<!-- HERO -->
<section class="hero">
  <!-- Pastilla de RBGp: SOLO esto adentro -->
  <div class="pill">
    <img src="img/brand-mark-wg-128.png" alt="" onerror="this.style.display='none'">
    RBGp: <b id="balRBGp" aria-live="polite">0.000</b>
  </div>

  <!-- Moneda (coin) â€” YA NO va dentro de .pill -->
  <div class="coinWrap" id="coinBox">
    <div class="ring"></div>
    <canvas id="fx"></canvas>

    <div id="coin" class="coin" aria-label="Tap">
      <svg id="windowArc" viewBox="0 0 100 100" style="position:absolute;inset:0;width:100%;height:100%;opacity:0;pointer-events:none;transform:rotate(-90deg);z-index:6">
        <defs>
          <linearGradient id="frenzy777" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="#ff0055"/>
            <stop offset="20%"  stop-color="#ff9500"/>
            <stop offset="40%"  stop-color="#ffee00"/>
            <stop offset="60%"  stop-color="#33dd55"/>
            <stop offset="80%"  stop-color="#33aaff"/>
            <stop offset="100%" stop-color="#aa66ff"/>
          </linearGradient>
        <!-- â­ Gradiente radial para el aro (mÃ¡s intenso) -->
  <radialGradient id="haloArc" cx="50%" cy="50%" r="65%">
    <stop offset="0%"   stop-color="#ffffff" stop-opacity="1"/>
    <stop offset="35%"  stop-color="#FFD872" stop-opacity="1"/>
    <stop offset="70%"  stop-color="#cfae45" stop-opacity="0.8"/>
    <stop offset="100%" stop-color="#000000" stop-opacity="0"/>
  </radialGradient>

  <!-- â­ Filtro de glow nÃ­tido (no lava el color) -->
  <filter id="arcGlow" x="-60%" y="-60%" width="220%" height="220%">
    <feGaussianBlur in="SourceGraphic" stdDeviation="2.2" result="blur"/>
    <feMerge>
      <feMergeNode in="blur"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
        </defs>
        <circle cx="50" cy="50" r="46" fill="none" stroke="#ffd872" stroke-width="4" stroke-linecap="round" pathLength="360"></circle>
      </svg>

      <div id="windowTag"
  style="position:absolute;top:8px;right:10px;
         transform:none;
         padding:4px 10px;font-weight:800;font-size:12px;
         line-height:1;border-radius:12px;
         border:1px solid rgba(255,255,255,.18);
         background:rgba(0,0,0,.70);color:#ffd872;
         opacity:0;transition:opacity .14s,transform .18s;
         pointer-events:none;z-index:999"></div>


      <img src="img/Coin.png" alt="" class="coinImg" onerror="this.remove();document.getElementById('fallback').style.display='block'">
      <div id="fallback" class="coinFallback" style="display:none">ğŸª™</div>

      <div id="gain"
        style="position:absolute; left:0; top:0;
               font-size:14px; font-weight:900; color:#fff;
               text-shadow:0 2px 6px rgba(0,0,0,.55), 0 0 10px rgba(0,0,0,.35);
               pointer-events:none; z-index:1001;">
      </div>

      <div id="hot" style="
        position:absolute; inset:0;
        pointer-events:none; opacity:0; transition:opacity .18s ease;
        filter: drop-shadow(0 0 10px rgba(255,223,120,.25));
      "></div>

      <div id="hotCore" style="
        position:absolute; left:50%; top:50%;
        transform:translate(-50%,-50%);
        width:0; height:0; border-radius:50%;
        pointer-events:none; opacity:0;
        box-shadow: 0 0 6px rgba(0,0,0,.25) inset, 0 0 6px rgba(255,255,255,.15);
      "></div>



<div id="comboBadge" style="
  position:absolute; top:10px; left:10px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18);
  color:#ffd872; font-weight:800; font-size:12px;
  padding:4px 8px; border-radius:10px; display:none; pointer-events:none;">
  <span id="comboTxt">COMBO x1</span>
</div>



    <!-- BotÃ³n Ideas anclado a la moneda -->
    <button id="ideasBtn" class="idea-btn" aria-label="Ideas">
      <img src="img/icon-idea.png" alt="Ideas" onerror="this.style.display='none'">
    </button>
  </div>

  <!-- DOCK bajo la moneda -->
  <div class="action-dock" aria-label="acciones rÃ¡pidas">
    <button id="refillBtn" class="btn-icon" aria-label="Refill">
      <img src="img/ico-refill.png" alt="Perfil" style="width:40px;height:40px;">
      <span id="refillPrice" class="price-pill">0.10 WLD</span>
    </button>
    <button id="openUp" class="btn-icon" aria-label="Boosters">
      <img src="img/icon-gear.png" alt="Perfil" style="width:40px;height:35px;">
    </button>
  </div>

  <div class="energyWrap">
    <div class="energyBar"><div id="energyFill" class="energyFill" style="width:100%"></div></div>
    <div class="energyLbl">âš¡ <b id="energyNow">100</b>/<b id="energyMax">100</b></div>
  </div>
</section>





<!-- Drawers (Boosters simple + Inbox placeholder+Perfil) -->
<div id="backdropUP" class="backdrop"></div>
<aside id="drawerUP" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('UP')">x</button>
  <div class="drawer-body">
    <h3 data-i18n="boosters_title">Impulsores</h3>
    <p style="opacity:.85" data-i18n="coming_soon">Proximamente... âœ”</p>
  </div>
</aside>



<div id="backdropIN" class="backdrop"></div>
<aside id="drawerIN" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('IN')">x</button>
  <div class="drawer-body">
    <h3>ğŸ“¥ BuzÃ³n</h3>
    <div id="inboxList" class="chatList"></div>
    <button id="markRead" class="btnPro">Marcar todo como leÃ­do</button>
  </div>
</aside>

<!-- Drawer IDEAS -->
 <div id="backdropID" class="backdrop"></div>
<aside id="drawerID" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('ID')">x</button>
  <div class="drawer-body">
  <h3 data-i18n="ideas_title">Ideas</h3>


  <!-- Vista inicial: pagar -->
  <div id="ideasPayView" class="cardPro">
   <p data-i18n="ideas_pay_intro">Â¡SÃ© parte de los desarrolladores y carrera con la comunidad PARTICIPA!</p>
  <button id="payIdeasBtn" class="btn-icon">
  <img src="img/icon-idea.png" alt="pagar" style="width:28px;height:28px;">
  <span data-i18n="ideas_pay_btn">Comprar ticket</span>
  <span class="price-pill"><b>1 WLD ğŸŸï¸</b></span>
</button>
</div>


  <!-- Vista desbloqueada: opciones -->
  <div id="ideasOptionsView" class="cardPro" style="display:none">
  <p><b data-i18n="ideas_choose">Escoge una opciÃ³n</b></p>
  <p id="ticketTimer" style="margin:10px 0;font-size:14px;color:#ffd872;font-weight:bold">
  Tiempo restante: 05:00
  </p>
  <button id="voteBtn" class="btn-icon btnPro"><b data-i18n="vote">Votarâœï¸</b></button>
  <button id="suggestBtn" class="btn-icon btnPro"><b data-i18n="suggest">SugerenciağŸ’¡</b></button>
  <p style="font-size:12px;opacity:.6;margin-top:6px">
  <i data-i18n="each_action_consumes">*Cada acciÃ³n consume 1 ticket</i>
  </p>

  </div>
  <!-- Vista: Encuesta -->
<div id="ideasPollView" class="cardPro" style="display:none">
<h4 style="margin:6px 0 8px" data-i18n="poll_title">ğŸ Â¡EMPIEZA LA CARRERA!</h4>
<p class="hint"><b data-i18n="poll_hint">TÃš ELIGESğŸ’Š</b></p>


  <!-- Opciones -->
  <div style="display:grid; gap:8px; margin:10px 0 12px;">
    <button class="btn" id="pollOptA"><b data-i18n="opt_a">Comodidad/SeguridadğŸ”µ</b></button>
<button class="btn" id="pollOptB"><b data-i18n="opt_b">Cambio/RiesgoğŸ”´</b></button>
<button class="btn" id="pollOptC"><b data-i18n="opt_c">Autotap ğŸ¤–</b></button>
</div>

  <!-- Resultados (barras simples) -->
  <div id="pollResults" style="display:none; margin-top:10px;">
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">A</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barA" style="height:100%;width:0;background:#c9a848"></div>
      </div>
      <span id="pctA" style="width:48px;text-align:right">0%</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">B</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barB" style="height:100%;width:0;background:#9aa0ff"></div>
      </div>
      <span id="pctB" style="width:48px;text-align:right">0%</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <span style="width:58px;opacity:.8">C</span>
      <div style="flex:1;background:#0f0e13;border:1px solid #2a2930;border-radius:8px;overflow:hidden;height:10px">
        <div id="barC" style="height:100%;width:0;background:#78d59c"></div>
      </div>
      <span id="pctC" style="width:48px;text-align:right">0%</span>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-top:12px;">
   <button class="btn" id="pollClose" data-i18n="poll_close">Cerrar</button>
  </div>
</div>

<!-- Vista: Enviar sugerencia -->
<div id="ideasSuggestView" class="cardPro" style="display:none">
  <h4 style="margin:6px 0 8px" data-i18n="suggest_title">Â¿Alguna idea?</h4>
<p class="hint"><b data-i18n="suggest_hint">MÃ¡x. 400 caracteres.</b></p>
<textarea id="suggestText" class="textareaPro" rows="5" maxlength="240"
  data-i18n-placeholder="placeholder_suggest"
  placeholder="Escribe tu idea o mejora aquÃ­â€¦" style="width:100%;"></textarea>

<button class="btn" id="sendSuggestBtn" data-i18n="send">Enviar</button>
<button class="btn" id="sugClose" data-i18n="close">Cerrar</button>

  </div>
</div>


</aside>


<div id="backdropPF" class="backdrop"></div>
<aside id="drawerPF" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('PF')">x</button>
  <div class="drawer-body">
  <h3 data-i18n="profile_title" style="margin:0 0 12px">Perfil</h3>
  <div class="cardPro">
<label data-i18n="username_label" style="display:block;margin-bottom:8px;font-size:14px;">Nombre de usuario</label>
<input id="usernameInput"  class="inputPro" type="text"
  style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;"
  data-i18n-placeholder="username_placeholder"
  placeholder="Tu nombre">

<div id="saveRow" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
  <button id="saveUsernameBtn" class="btn-icon" style="min-height:auto;padding:6px 10px;display:none" data-i18n="save">Guardar</button>
  <small style="font-style: italic; color: gray;">
  MÃ¡x. 3
</small>
  <span id="savedBadge" style="display:none;font-size:12px;color:#ffd872;">âœ“ <span data-i18n="saved">Guardado</span></span>
</div>

<label data-i18n="language_label" style="display:block;margin:16px 0 8px;font-size:14px;">Idioma</label>
<select id="langSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;">
  <option value="es" data-i18n="option_es">EspaÃ±ol</option>
  <option value="en" data-i18n="option_en">InglÃ©s</option>
</select>

<div style="margin:16px 0;">
  <p><span data-i18n="profile_rbgp_label">RBGp:</span> <b id="profRBGp">0.000</b></p>
  <p style="opacity:.7;"><span data-i18n="profile_rbg_label">RBG Balance:</span> <b id="profRBG">--</b> ğŸ”’</p>
  <p style="opacity:.7;"><span data-i18n="profile_wld_label">WLD Balance:</span> <b id="profWLD">--</b> ğŸ”’</p>
</div>

<button id="claimBtn" class="btn-icon" disabled style="opacity:.5;" data-i18n="claim_soon">Reclamar (Pronto)</button>
</div>
<div class="legal-in-profile">
  <a class="legal-link" href="/terminos" target="_blank" rel="noopener">TÃ©rminos</a> Â·
  <a class="legal-link" href="/privacidad" target="_blank" rel="noopener">Privacidad</a>
</div>



</aside>
<script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js"></script>
<script>
// === Conectar tu botÃ³n #wldSignIn al login SIWE (World App) ===
// (Reemplaza por completo el bloque viejo que redirigÃ­a a /auth/login)

window.WLD = window.WLD || {};
function when(cond, cb, tries=50, delay=100){
  const t = setInterval(() => {
    try{
      if (cond()) { clearInterval(t); cb(); }
      else if (--tries<=0) clearInterval(t);
    }catch(e){ clearInterval(t); }
  }, delay);
}

// WLD.login ahora ejecuta SIWE (NO redirige a /auth/login)
window.WLD.login = function(){
  if (typeof loginSiwe === "function") {
    return loginSiwe().catch(err => alert("Error SIWE: " + (err?.message || err)));
  } else {
    when(() => typeof loginSiwe === "function",
         () => loginSiwe().catch(err => alert("Error SIWE: " + (err?.message || err))));
  }
};

// Enlazar tu botÃ³n del splash
document.addEventListener("DOMContentLoaded", function(){
  const b = document.getElementById("wldSignIn");
  if (b) b.addEventListener("click", () => { if (window.WLD && WLD.login) WLD.login(); });
});

// Auto-sesiÃ³n: si ya hay sesiÃ³n vÃ¡lida, entramos directo (usa /api/me de tu backend)
(async () => {
  try {
    const me = await fetch("/api/me", { credentials: "include" }).then(r => r.json());
    if (me && me.ok) gotoGame(); else gotoLogin();
  } catch {
    gotoLogin();
  }
})();
</script>


    <!-- MiniKit Pay botones de ejemplo (puedes quitar si no los usas aquÃ­) -->
    <div style="padding:12px;">
      <div class="row">
        <button id="pay-refill" class="btn">Comprar Refill (0.1 WLD)</button>
        <button id="pay-idea" class="btn">Ticket de Ideas (1 WLD)</button>
      </div>
      <div id="status" style="margin-top:10px;"></div>
    </div>
  </div>


<script>
(async () => {
  const WC_PROJECT_ID = "ddfa618a5dda216e266d0659744df365";
  const API_BASE = "/api";

  const { createConfig, reconnect, getAccount, connect, getChainId, signMessage } = window.wagmiCore;
  const { defaultWagmiConfig, createWeb3Modal } = window.WEB3MODAL_WAGMI;
  const chains = [{ id: 8453, name: 'Base', nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, rpcUrls: { default: { http: ['https://mainnet.base.org'] } } }];

  const wagmiConfig = createConfig(defaultWagmiConfig({
    chains,
    projectId: WC_PROJECT_ID,
    enableInjected: false,
    enableWalletConnect: true,
    enableCoinbase: false
  }));
  createWeb3Modal({ wagmiConfig, projectId: WC_PROJECT_ID, themeMode: 'dark' });
  await reconnect(wagmiConfig);
    window.__state = window.__state || { loggedIn:false, gameStarted:false };

  function gotoLogin(){
    const splash = document.getElementById("splash");
    const gameScreen = document.getElementById("game-screen");
    if (splash) splash.style.display = "flex";
    if (gameScreen) gameScreen.style.display = "none";
    document.body.dataset.view = "login";
  }

  function gotoGame(){
    const splash = document.getElementById("splash");
    const gameScreen = document.getElementById("game-screen");

    if (splash) splash.style.display = "none";
    if (gameScreen) gameScreen.style.display = "block";
    document.body.dataset.view = "game";

    // Arranca el juego SOLO una vez
    if (!window.__state.gameStarted && window.__runGame){
      window.__state.gameStarted = true;
      try { window.__runGame(); } catch(e){ console.error(e); }
    }
  }

  // Anti-loop: si algo intenta re-mostrar el splash estando en "game", lo escondemos
  const mo = new MutationObserver(() => {
    if (document.body.dataset.view === "game") {
      const ids = ["splash","loading","loader","preloader","wldstate"];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = "none"; });
      document.querySelectorAll(".splash,.splash_screen,.splash-container,.loading,.loader,.preloader")
        .forEach(el => el.style.display = "none");
    }
  });
  mo.observe(document.body, { attributes:true, childList:true, subtree:true });

  async function api(path, opts) {
    const res = await fetch(API_BASE + path, { credentials: "include", ...opts });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function ensureConnected() {
    const acc = getAccount(wagmiConfig);
    if (!acc.isConnected) {
      await connect(wagmiConfig, { connector: wagmiConfig.connectors[0] });
    }
    const a = getAccount(wagmiConfig);
    if (!a.address) throw new Error("No hay address de World App");
    return a.address;
  }

  async function loginSiwe() {
    const address = await ensureConnected();
    const { nonce } = await api("/nonce", { method: "GET" });

    const statement = "Iniciar sesiÃ³n en RainbowGold Tap";
    const chainId = getChainId(wagmiConfig) || 1;
    const message = [
      `${address} quiere iniciar sesiÃ³n`,
      ``,
      `URI: ${location.origin}`,
      `Version: 1`,
      `Chain ID: ${chainId}`,
      `Nonce: ${nonce}`,
      `Issued At: ${new Date().toISOString()}`,
      `Statement: ${statement}`
    ].join("\n");

    const signature = await signMessage(wagmiConfig, { message });
    const ver = await api("/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, signature })
    });
    if (ver.ok) {
      gotoGame();

    } else {
      throw new Error("VerificaciÃ³n SIWE fallÃ³");
    }
  }

 const siweBtn = document.getElementById("siweBtn");
if (siweBtn) {
  siweBtn.addEventListener("click", () => {
    loginSiwe().catch(err => alert("Error SIWE: " + (err?.message || err)));
  });
}
    const wldBtn = document.getElementById("wldSignIn");
  const wldState = document.getElementById("wldState");
  function setBusy(on){
    if (wldBtn) { wldBtn.disabled = !!on; wldBtn.style.opacity = on ? "0.6" : "1"; }
    if (wldState) wldState.style.display = on ? "block" : "none";
  }
  if (wldBtn) {
    wldBtn.addEventListener("click", async () => {
      try { setBusy(true); await loginSiwe(); }
      catch (err) { alert("Error SIWE: " + (err?.message || err)); }
      finally { setBusy(false); }
    });
  }

  // Si ya hay sesiÃ³n valida, entra directo
 try {
  const me = await api("/me", { method: "GET" });
  if (me.ok) {
    gotoGame();
  } else {
    gotoLogin();
  }
} catch {
  gotoLogin();
}


  // MiniKit Pay helpers
  function ensureMiniKit() {
    if (!window.MiniKit) { throw new Error("MiniKit no disponible"); }
    return window.MiniKit;
  }

  async function payWLD(amountWLD, description) {
    await ensureConnected();
    const order = await api("/pay/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amountWLD, description })
    });
    if (!order.ok) throw new Error("No se pudo crear la orden");
    const MiniKit = ensureMiniKit();
    const payRes = await MiniKit.pay?.({
      amount: amountWLD,
      asset: "WLD",
      description,
      reference: order.orderId
    });
    if (payRes?.status === "success") {
      await api("/pay/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId: order.orderId, txHash: payRes.txHash || null })
      });
      return true;
    } else {
      throw new Error(payRes?.error || "Pago cancelado o fallido");
    }
  }

  const s = document.getElementById("status");
  const btnRefill = document.getElementById("pay-refill");
  const btnIdea = document.getElementById("pay-idea");
  if (btnRefill) btnRefill.addEventListener("click", async () => {
    if (s) s.textContent = "Procesando pago de refill...";
    try { await payWLD(0.1, "Refill de energÃ­a"); if (s) s.textContent = "Pago OK. Refill aplicado."; }
    catch (e) { if (s) s.textContent = "Pago fallido: " + (e?.message || e); }
  });
  if (btnIdea) btnIdea.addEventListener("click", async () => {
    if (s) s.textContent = "Procesando pago de ticket de ideas...";
    try { await payWLD(1, "Ticket de Ideas"); if (s) s.textContent = "Pago OK. Ticket otorgado."; }
    catch (e) { if (s) s.textContent = "Pago fallido: " + (e?.message || e); }
  });
})();
</script>

  <script src="js/bootstrap.js"></script>
  <script src="js/core.js"></script>
  <script src="js/ui.js"></script>

<script>
(function(){
  var WC_ID = window.WC_PROJECT_ID || "ddfa618a5dda216e266d0659744df365";
  var CHAIN_ID = 8453;
  function ready(){ return !!(window.w3m && window.wagmiCore && window.wagmiActions); }
  async function ensureCfg(){
    if (window.wagmiConfig) return window.wagmiConfig;
    try{
      var createConfig = window.wagmiCore.createConfig;
      var http = window.wagmiCore.http;
      var base = (window.viemChains && window.viemChains.base) || (window.viem && window.viem.chains && window.viem.chains.base);
      var defaultWagmiConfig = window.w3m.defaultWagmiConfig;
      var createWeb3Modal = window.w3m.createWeb3Modal;
      var cfg = createConfig(defaultWagmiConfig({ chains:[base], projectId: WC_ID, metadata: meta, transports: (function(o){ o[base.id]=http(); return o; })({}), enableAnalytics:false }));
      window.wagmiConfig = cfg; createWeb3Modal({ wagmiConfig: cfg, projectId: WC_ID });
      return cfg;
    }catch(e){ console.error('wagmiConfig error', e); return null; }
  }
  async function siwe(){
    var cfg = await ensureCfg(); if (!cfg) throw new Error('wagmiConfig no disponible');
    var getAccount = window.wagmiCore.getAccount;
    var connect = window.wagmiCore.connect;
    var a = getAccount(cfg);
    if (!a.isConnected){
      var wc = cfg.connectors.find(function(c){ return (c.id==='walletConnect') || ((c.name||'').toLowerCase().indexOf('walletconnect')>=0); }) || cfg.connectors[0];
      await connect(cfg, { connector: wc });
      a = getAccount(cfg);
    }
    if (!a.address) throw new Error('Sin address tras conectar');
    var nr = await fetch('/api/nonce', { credentials:'include' });
    var nj = await nr.json();
    var msg = [
      location.hostname + ' wants you to sign in with your Ethereum account:',
      a.address,
      '',
      'URI: ' + location.origin,
      'Version: 1',
      'Chain ID: ' + (a.chainId || CHAIN_ID),
      'Nonce: ' + nj.nonce,
      'Issued At: ' + new Date().toISOString()
    ].join('\n');
    var sig = await window.wagmiActions.signMessage(cfg, { message: msg });
    var vr = await fetch('/api/verify', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ message: msg, signature: sig }) });
    var v = await vr.json();
    if (!v.ok) throw new Error(v.error || 'VerificaciÃ³n fallÃ³');
    if (window.gotoGame) window.gotoGame(); else if (window.__app__ && window.__app__.gotoGame) window.__app__.gotoGame();
  }
  function attach(){
    var btn = document.getElementById('wldSignIn') || Array.from(document.querySelectorAll('button')).find(function(b){ return /conectar/i.test(b.textContent); });
    if (btn) btn.addEventListener('click', function(){ siwe().catch(function(e){ alert('Error SIWE: ' + (e && e.message ? e.message : e)); console.error(e); }); }, { passive:true });
  }
  function wait(i){ if (i>40) return; if (ready()) return attach(); setTimeout(function(){ wait((i||0)+1); }, 100); }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', function(){ wait(0); }); else wait(0);
})();
</script>

</body>
</html>