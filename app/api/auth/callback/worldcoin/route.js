export const runtime='nodejs';export const dynamic='force-dynamic';import{NextResponse}from'next/server';export async function GET(req){const u=new URL(req.url);const code=u.searchParams.get('code');if(!code)return NextResponse.redirect(new URL('/?error=missing_code',u.origin));const id=process.env.WORLD_ID_CLIENT_ID;const sec=process.env.WORLD_ID_CLIENT_SECRET;const red=process.env.WORLD_ID_REDIRECT_URI;const basic=Buffer.from(`${id}:${sec}`).toString('base64');const tr=await fetch('https://id.worldcoin.org/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','Authorization':'Basic '+basic},body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:red})});if(!tr.ok)return NextResponse.redirect(new URL('/?error=token_exchange_failed',u.origin));const tj=await tr.json();let profile={};if(tj.access_token){try{const r=await fetch('https://id.worldcoin.org/userinfo',{headers:{Authorization:`Bearer ${tj.access_token}`}});if(r.ok)profile=await r.json()}catch{}}const name=profile.name||profile.given_name||'Jugador';const email=profile.email||'';const sub=profile.sub||'';const wallet=profile.wallet?.address||(Array.isArray(profile.wallets)&&profile.wallets[0]?.address)||'';const verification=profile.verification_level||profile.verification?.level||(profile['https://id.worldcoin.org/claims/verification']&&profile['https://id.worldcoin.org/claims/verification'].level)||'';const front=new URL('/index.html',u.origin);front.searchParams.set('token',tj.id_token||tj.access_token||'ok');const res=NextResponse.redirect(front);res.cookies.set('rj_session',JSON.stringify({name,email,sub,wallet,verification}),{httpOnly:true,sameSite:'lax',secure:true,path:'/',maxAge:60*60*24*7});return res}