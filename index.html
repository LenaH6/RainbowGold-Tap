<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>RainbowGold Tap</title>
  <meta name="theme-color" content="#1b103a" />

  <!-- ‚úÖ CSP MEJORADA para MiniKit -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://unpkg.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' https:;
    connect-src 'self' https://rainbowgold-api.vercel.app https://developer.worldcoin.org https://unpkg.com https://cdn.jsdelivr.net wss: ws:;
    media-src 'self';
  ">

  <!-- Config global del backend -->
  <script>
    window.API_BASE = "https://rainbowgold-api.vercel.app";
  </script>

  <!-- ‚úÖ CARGA MEJORADA DE MINIKIT -->
  <script>
    // Funci√≥n para cargar MiniKit con retry
    function loadMiniKit() {
      return new Promise((resolve, reject) => {
        // Intentar con la URL principal
        const script1 = document.createElement('script');
        script1.src = 'https://unpkg.com/@worldcoin/minikit-js@latest/dist/minikit.js';
        script1.async = true;
        
        script1.onload = () => {
          console.log('‚úÖ MiniKit cargado desde unpkg');
          resolve();
        };
        
        script1.onerror = () => {
          console.warn('‚ö†Ô∏è Fall√≥ unpkg, intentando jsdelivr...');
          document.head.removeChild(script1);
          
          // Fallback a jsdelivr
          const script2 = document.createElement('script');
          script2.src = 'https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js';
          script2.async = true;
          
          script2.onload = () => {
            console.log('‚úÖ MiniKit cargado desde jsdelivr');
            resolve();
          };
          
          script2.onerror = () => {
            console.error('‚ùå Error cargando MiniKit desde ambas CDNs');
            reject(new Error('Failed to load MiniKit'));
          };
          
          document.head.appendChild(script2);
        };
        
        document.head.appendChild(script1);
      });
    }

    // Cargar MiniKit antes que el resto
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadMiniKit();
        console.log('üéØ MiniKit est√° disponible:', {
          MiniKit: !!window.MiniKit,
          VerificationLevel: !!window.VerificationLevel
        });
      } catch (error) {
        console.error('‚ùå Error cargando MiniKit:', error);
      }
    });
  </script>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <!-- === SPLASH / CARGA INICIAL === -->
  <div id="splash" class="splash" aria-busy="true" aria-label="Cargando RainbowGold">
    <div class="splash__logo">
      <img src="assets/img/logo-splash.png" alt="RainbowGold" fetchpriority="high" decoding="async">
    </div>

    <button id="wldSignIn" style="
      margin-top:18px;padding:12px 16px;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:#fff;font-weight:700;cursor:pointer">
      Entrar con World ID
    </button>

    <div id="wldState" class="splash__hint" style="margin-top:10px;opacity:1;transform:translateY(0)">
      <span>Preparando tu sesi√≥n</span>
      <span class="dots"><span>.</span><span>.</span><span>.</span></span>
    </div>
  </div>

  <!-- Resto del HTML igual... -->
  <div class="floatCol">
    <button id="profileBtn" class="fab profile" title="Profile">
      <img src="assets/img/icon-profile.png" alt="Perfil" style="width:45px;height:45px;">
    </button>
    <button id="inboxBtn" class="fab inbox" title="Inbox">
      <img src="assets/img/icon-inbox.png" alt="Inbox" style="width:35px;height:35px;">
      <span id="inboxBadge" class="badge" style="display:none">0</span>
    </button>
  </div>

  <!-- Scripts de la app (ORDEN IMPORTANTE) -->
  <script src="js/api-config.js"></script>
  <script src="js/game-logic.js"></script>
  <script src="js/payments.js"></script>
  <!-- MiniKit config va al final -->
  <script type="module" src="js/minikit-config.js"></script>
</body>
</html>