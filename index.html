<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>WorldGold — Tap</title>
<meta name="theme-color" content="#1b103a">
<style>
:root{
  --bg1:#6C48FF; --bg2:#1B103A; --ink:#fff; --mut:#C7C4FF;
  --gold:#F4C542; --gold-soft:#FFD872;
  /* MÁS GRANDE y calzada */
  --heroSize: clamp(100px, 60vw, 500px);
  --coinSize: clamp(100px, 60vw, 500px);
}

/* === Global reset + base === */
*{box-sizing:border-box}html,body{height:100%}
body{
  margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  color:var(--ink); background:radial-gradient(120% 120% at 50% 20%, #0b0818 0%, #000 70%);
  touch-action:manipulation;
}
img{display:block;max-width:100%}

/* Estrellas y ruido (decor) */
.stars, .stars2, .noise{position:fixed; inset:0; pointer-events:none; z-index:0}
.stars{background:radial-gradient(#fff1 1px, transparent 1px); background-size:3px 3px; opacity:.25}
.stars2{background:radial-gradient(#fff2 1px, transparent 1px); background-size:4px 4px; opacity:.18}
.noise{background-image:url('img/noise.png'); mix-blend-mode:overlay; opacity:.03}

/* Topbar / Acciones superiores */
.topbar{position:sticky; top:0; z-index:10; padding:10px 14px; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px)}
.top-actions{position:absolute; right:8px; top:8px; display:flex; align-items:center; gap:12px}

/* Tip (tooltip simple) */
.tip{position:absolute; top:36px; right:0; padding:6px 10px; font-size:12px; color:#fff; background:rgba(33,33,55,.9); border:1px solid rgba(255,255,255,.18); border-radius:10px; opacity:0; pointer-events:none; transform:translateY(-6px); transition:opacity .18s, transform .18s}

/* FABs */
.floatCol{position:fixed; left:10px; top:54px; display:flex; flex-direction:column; gap:12px; z-index:20}
.fab{width:50px;height:50px; display:grid;place-items:center; border-radius:14px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04)); box-shadow:0 10px 30px rgba(0,0,0,.35); transition:transform .2s ease, filter .3s ease}
.fab:active{transform:scale(.96)}
.fab.profile,.fab.trophy,.fab.inbox{background:transparent; box-shadow:none}
.badge{position:absolute; top:-6px; right:-6px; background:#ff3b3b; color:#fff; font-size:11px; padding:2px 6px; border-radius:10px}

/* === Splash / Pantalla de carga === */
.splash {
  position: fixed; inset: 0; z-index: 9999;           /* por encima de todo */
  display: grid; place-items: center;
  background: radial-gradient(120% 120% at 50% 20%, #0f0f14 0%, #000 70%);
  transition: opacity .36s ease;
  opacity: 1;
  pointer-events: auto;                                /* bloquea la UI detrás */
}
.splash--hide { opacity:0; pointer-events:none; }      /* libera la UI al ocultar */

.splash__logo {
  width: clamp(140px, 36vw, 220px); height: clamp(140px, 36vw, 220px);
  border-radius: 28px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  display: grid; place-items: center;
  padding: 10px;
  box-shadow: 0 16px 40px rgba(0,0,0,.55), 0 0 28px rgba(255, 220, 120, .18);
  animation: zoom-in 1s ease forwards;
}
@keyframes zoom-in { 0%{transform:scale(1.3);opacity:0}60%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:1} }
.splash__logo img { width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 0 10px rgba(255,223,120,.35)); animation:breathe 3s ease-in-out infinite; }
@keyframes breathe { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }

.splash__hint{
  margin-top: 12px; color: var(--mut); font-size: 13px; text-align: center;
  opacity:0; transform:translateY(6px); transition:opacity .8s ease, transform .8s ease;
}
/* Sign-in button on splash */
.btn-signin{margin-top:12px; padding:10px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04)); color:#fff; font-weight:600; font-size:15px; backdrop-filter: blur(6px); box-shadow: 0 4px 24px rgba(0,0,0,.35);}
.btn-signin:active{transform:scale(.97)}

/* Hero + moneda */
.hero{display:grid; place-items:center; margin-top:24px}
.coinWrap{position:relative; width:var(--coinSize); height:var(--coinSize); margin:16px auto 8px; z-index:3}
.ring{position:absolute; inset:-10px; border-radius:50%; border:1px solid rgba(255,255,255,.18); filter:blur(0.3px)}
.coin{position:absolute; inset:0; display:grid; place-items:center; border-radius:50%; overflow:hidden; pointer-events:auto; touch-action:manipulation}
.coinImg{width:100%; height:100%; object-fit:contain; image-rendering:-webkit-optimize-contrast}
.coinFallback{font-size:52px}

/* Gain (número del tap) */
.gain{position:absolute; left:50%; top:44%; transform:translate(-50%,-50%); font-weight:900; font-size:20px; opacity:0; pointer-events:none}
.gain.show{animation:float .6s ease-out forwards}
@keyframes float{from{opacity:0; transform:translate(-50%,-10px) scale(.9)} 50%{opacity:1} to{opacity:0; transform:translate(-50%,-40px) scale(1.05)}}

/* Canvas FX */
#fx{position:absolute; inset:0; pointer-events:none}
/* Idea button next to coin */
.ideaBtn{position:absolute; right:-6px; top:-6px; width:44px; height:44px; display:grid; place-items:center; border-radius:50%; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); backdrop-filter: blur(6px); z-index:5; touch-action:manipulation}
.ideaBtn:active{transform:scale(.96)}

/* Dock (Refill + Booster) debajo de la moneda */
.action-dock{display:flex; align-items:center; justify-content:center; gap:14px; margin-top:12px; z-index:4}
.btn-icon{
  display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px;
  border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
  color:#fff; font-weight:600; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.btn-icon.pulse{animation:pulse 1.6s infinite}
@keyframes pulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}
.btn-icon:active{transform:scale(.96)}
.btn-icon img{display:block}

/* Energia bar */
.energyBar{width:min(520px,92vw); margin:12px auto 10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px}
.energyFill{height:8px; background:linear-gradient(90deg, #ffd65a, #ffb347); border-radius:6px; width:0}
.energyLbl{margin-top:6px; font-size:13px; color:var(--mut)}

/* Drawer simple */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s; z-index:40}
.backdrop.show{opacity:1; pointer-events:auto}
.drawer{position:fixed; top:0; right:-380px; width:min(360px,92vw); height:100dvh; background:rgba(10,8,24,.98); border-left:1px solid rgba(255,255,255,.1); padding:16px 16px calc(24px + env(safe-area-inset-bottom)); transition:right .28s ease; overflow:auto; z-index:60}
.drawer.show{right:0}
.drawer .close{position:sticky; top:0; margin-left:auto; width:34px; height:34px; border-radius:50%; border:1px solid rgba(255,255,255,.25); background:transparent; color:#fff; cursor:pointer; font-size:18px}

/* Demo card */
.card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:12px}

/* Simple table for Inbox */
.inbox-list{display:flex; flex-direction:column; gap:10px}

/* Utility */
.hidden{display:none}
.shake{animation:shk .26s cubic-bezier(.11,.66,.3,.99)}
@keyframes shk{10%{transform:translateX(2px)} 30%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 70%{transform:translateX(-1px)} 100%{transform:translateX(0)}}
</style>
</head>
<body>
  <!-- === SPLASH / CARGA INICIAL === -->
<div id="splash" class="splash" aria-busy="true" aria-label="Loading WorldGold">
  <div class="splash__logo">
    <img src="img/logo-splash.png" alt="WorldGold" onerror="this.style.display='none'">
  </div>
  <button id="worldIdBtn" class="btn-signin" type="button">Sign in with World ID</button>
  <div id="splashHint" class="splash__hint">Preparing session…</div>
</div>

  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="noise" aria-hidden="true"></div>

<!-- Left FABs -->
<div class="floatCol">
  <button id="profileBtn" class="fab profile" title="Profile">
    <img src="img/icon-profile.png" alt="Profile" style="width:45px;height:45px;">
  </button>
  <button id="inboxBtn" class="fab inbox" title="Inbox">
    <img src="img/icon-inbox.png" alt="Inbox" style="width:45px;height:45px;">
    <span id="unreadBadge" class="badge hidden">0</span>
  </button>
</div>

<!-- Topbar -->
<div class="topbar">
  <h1 class="logo-text"></h1>
</div>

<!-- Botón trofeo en top-actions -->
<div class="top-actions" style="overflow:visible">
  <div><span data-i18n="wld_balance">Saldo WLD:</span></div>
  <div><b id="balWLD">0.00</b> WLD</div>
  <div class="trophyWrap">
    <button id="trophyBtn" class="fab trophy" title="Leaderboard" type="button" aria-describedby="trophyTip">
      <img src="img/icon-trophy.png" alt="Trophy" style="width:25px;height:25px;">
    </button>
    <div id="trophyTip" class="tip" data-i18n="coming_soon">Próximamente</div>
  </div>
</div>

<!-- HERO -->
<section class="hero" aria-label="hero">
  <div style="text-align:center; opacity:.92">
    <div data-i18n="hello_user" style="font-size:16px; opacity:.82">Hello Player!</div>
  </div>

  <div class="coinWrap" id="coinBox">
    <div class="ring"></div>
    <canvas id="fx"></canvas>
    <button id="ideaBtn" class="ideaBtn" title="Idea"><img src="img/icon-idea.png" alt="Idea" style="width:28px;height:28px;"></button>
    <div id="coin" class="coin" aria-label="Tap">
      <img src="img/Coin.png" alt="" class="coinImg" onerror="this.remove(); document.getElementById('fallback').style.display='block'">
      <div id="fallback" class="coinFallback" style="display:none">🪙</div>
      <div id="gain" class="gain">+0.40</div>
    </div>
  </div>

  <!-- DOCK bajo la moneda -->
  <div class="action-dock" aria-label="acciones rápidas">
    <button id="refillBtn" class="btn-icon" aria-label="Refill">
      <img src="img/ico-refill.png" alt="Refill" style="width:40px;height:40px">
      <span id="refillPrice">0.00 WLD</span>
    </button>
    <button id="openUp" class="btn-icon" aria-label="Boosters">
      <img src="img/icon-rocket.png" alt="Boosters" style="width:40px;height:40px">
      <span data-i18n="boosters_title">Impulsores</span>
    </button>
  </div>

  <!-- Barra de energía -->
  <div class="energyBar">
    <div id="energyFill" class="energyFill"></div>
    <div class="energyLbl"><span id="energyNow">0</span>/<span id="energyMax">100</span> energy</div>
  </div>
</section>

<!-- Drawers (Boosters simple + Inbox placeholder+Perfil) -->
<div id="backdropUP" class="backdrop"></div>
<aside id="drawerUP" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('UP')">x</button>
  <h3 data-i18n="boosters_title">Impulsores</h3>
  <p style="opacity:.85">Any ideas what this could be?</p>
</aside>

<div id="backdropIN" class="backdrop"></div>
<aside id="drawerIN" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('IN')">x</button>
  <h3 data-i18n="inbox_title" style="margin:0 0 8px">Buzón</h3>
  <div id="inboxList" class="inbox-list"></div>
  <button id="markRead" class="btn-icon" data-i18n="mark_read">Marcar como leído</button>
</aside>

<!-- Drawer Perfil -->
<div id="backdropPF" class="backdrop"></div>
<aside id="drawerPF" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('PF')">x</button>
  <h3 data-i18n="profile_title" style="margin:0 0 12px">Perfil</h3>

  <label data-i18n="username_label" style="display:block;margin-bottom:6px">Nombre de usuario</label>
  <input id="usernameInput" data-i18n-placeholder="username_placeholder" placeholder="Tu nombre" style="width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff">
  <div style="height:10px"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr; gap:8px; align-items:center">
    <div style="opacity:.82">WLGp:</div><div id="pf_wlgp">0.000</div>
    <div style="opacity:.82">WLG:</div><div id="pf_wlg">0.00</div>
    <div style="opacity:.82">WLD:</div><div id="pf_wld">0.00</div>
  </div>
  <div style="height:10px"></div>

  <label for="langSelect" style="display:block;margin-top:8px">Language</label>
  <select id="langSelect" style="width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff">
    <option value="en">English</option>
    <option value="es">Español</option>
  </select>
  <div style="height:12px"></div>

  <button id="saveProfile" class="btn-icon" data-i18n="save">Guardar</button>
  <span id="savedMsg" style="margin-left:8px;opacity:0;transition:opacity .18s" data-i18n="saved">Guardado</span>
</aside>

<!-- Drawer Idea Participation -->
<div id="backdropIDEA" class="backdrop"></div>
<aside id="drawerIDEA" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Close" onclick="closeDrawer('IDEA')">x</button>
  <h3 style="margin:0 0 12px">Idea Survey</h3>
  <p style="opacity:.85;margin:0 0 10px">Pay <b>1.2 WLD</b> to participate or add a private comment. You must verify with World ID first.</p>
  <div id="ideaPaidBadge" style="font-size:12px;opacity:.8;margin:4px 0 10px">Status: <span id="ideaPaidState">Not paid</span></div>
  <textarea id="ideaComment" rows="5" placeholder="Your private comment…" style="width:100%;border-radius:10px;padding:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;resize:vertical"></textarea>
  <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
    <button id="ideaPayBtn" class="btn-icon" type="button">Pay 1.2 WLD</button>
    <button id="ideaSubmitBtn" class="btn-icon" type="button" disabled>Submit</button>
  </div>
</aside>

<!-- DEMO SECTION (puedes ocultarlo en prod) -->
<section class="card" style="width:min(560px,92vw); margin:20px auto">
  <h3 class="demoTitle" data-i18n="demo_title" style="margin:0 0 8px">Herramientas de prueba (demo)</h3>
  <div style="display:flex;gap:10px;justify-content:flex-end">
    <button id="btnAddWLD">+5 WLD</button>
    <button id="btnReset">Reset</button>
  </div>
</section>

<script>
(function splashController(){
  const splash = document.getElementById('splash');
  if (!splash) return;
  const hint = document.getElementById('splashHint');
  const btn  = document.getElementById('worldIdBtn');

  // Restore prior verification from localStorage
  let verified = (localStorage.getItem('verified') === 'true');
  window.isVerified = verified;

  const hide = () => {
    if (!splash) return;
    splash.classList.add('splash--hide');
    setTimeout(()=> splash.remove(), 450);
  };

  async function handleSignIn(){
    if (!btn) return;
    btn.disabled = true;
    if (hint) { hint.textContent = 'Verifying…'; hint.style.opacity = '1'; hint.style.transform = 'translateY(0)'; }
    try{
      const ok = await startWorldID(); // TODO: integrate real IDKit/World ID verification
      if (ok){
        verified = true; window.isVerified = true;
        localStorage.setItem('verified','true');
        if (hint) hint.textContent = 'Ready';
        setTimeout(hide, 600);
      }else{
        if (hint) hint.textContent = 'Preparing session…';
        btn.disabled = false;
      }
    }catch(err){
      console.error('World ID error', err);
      if (hint) hint.textContent = 'Preparing session…';
      btn.disabled = false;
    }
  }

  if (btn) btn.addEventListener('click', handleSignIn);

  // Auto-hide if already verified before
  window.addEventListener('load', () => {
    if (verified){
      if (hint) { hint.textContent = 'Ready'; hint.style.opacity = '1'; hint.style.transform = 'translateY(0)'; }
      setTimeout(hide, 300);
    } else {
      if (hint) { hint.textContent = 'Preparing session…'; hint.style.opacity = '1'; hint.style.transform = 'translateY(0)'; }
    }
  });
})();
/* ===== Helpers ===== */
const $=q=>document.querySelector(q);
let AC; function tone(f=560,d=.05,t='triangle',v=.08){try{AC=AC||new (window.AudioContext||window.webkitAudioContext)();const o=AC.createOscillator(),g=AC.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(AC.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+d);o.stop(AC.currentTime+d+0.02);}catch(e){}}

// === World ID verification (stub) ===
async function startWorldID(){
  // TODO: Integrate official World ID / IDKit verification here.
  // For now we simulate a successful verification.
  return new Promise(res => setTimeout(()=>res(true), 700));
}

// === Payments via World App (stub) ===
const WHITELIST_ADDR = '0x91bf252c335f2540871d0d2ef1476ae193a5bc8a';
async function worldAppPay({ amount, to = WHITELIST_ADDR, action = 'generic' }){
  // TODO: Integrate World App Action / WalletConnect / World Developers SDK.
  // Attempt deeplink or show a confirm dialog as a placeholder.
  try{
    // Placeholder UX
    return await new Promise(resolve=>{
      const ok = true; // simulate success
      setTimeout(()=>resolve(ok), 800);
    });
  }catch(e){
    console.error('Payment error', e);
    return false;
  }
}

/* ===== Estado base (demo) ===== */
const BASE_CAP=100, BASE_REGEN_PER_SEC=0.8, POWER_BASE=0.40;
let wld = +localStorage.getItem('wld') || 0;
let wlgp= +localStorage.getItem('wlgp')|| 0;
let energy=+localStorage.getItem('energy'); if(isNaN(energy)) energy=BASE_CAP;
let lastTs=+localStorage.getItem('last_ts')||Date.now();

/* ===== Derivados ===== */
function capMax(){return BASE_CAP}
function regenPerSec(){return BASE_REGEN_PER_SEC}
function priceRefill(){return +(capMax()/1000).toFixed(2)} // 0.1% capacidad
function lazyRegen(){const now=Date.now(),dt=(now-lastTs)/1000; lastTs=now; energy=Math.min(capMax(), energy+regenPerSec()*dt); localStorage.setItem('last_ts',String(lastTs)); localStorage.setItem('energy',String(energy));}

/* ===== Refs ===== */
const balWLD=$('#balWLD'), balWLGp=$('#balWLGp');
const coin=$('#coin'), gain=$('#gain');
const fx=$('#fx'), ctx=fx.getContext('2d');
const energyFill=$('#energyFill'), energyNow=$('#energyNow'), energyMax=$('#energyMax');
const refillBtn=$('#refillBtn'), refillPrice=$('#refillPrice');
const openUp=$('#openUp');
const profileBtn=$('#profileBtn'), drawerPF=$('#drawerPF'), backdropPF=$('#backdropPF');
const btnAddWLD=$('#btnAddWLD'), btnReset=$('#btnReset');

/* ===== Partículas con fallback ===== */
const sparkle = new Image(); sparkle.src = 'img/sparkle.png' ;
let parts=[];
function spawn(x,y){
  for(let i=0;i<14;i++){
    const a=Math.random()*Math.PI*2, sp=1.5+Math.random()*2.2, s=16+Math.random()*10;
    parts.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:600+Math.random()*400,size:s,alpha:1});
  }
}
function stepFX(dt){
  // Time normalization to be FPS-independent
  const k = dt / 16.7; // ~1 at 60fps
  const cx = fx.width/2, cy = fx.height/2, r = Math.min(fx.width, fx.height)/2;

  ctx.clearRect(0,0,fx.width,fx.height);
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.clip();

  const prevComp = ctx.globalCompositeOperation;
  const prevFilter = ctx.filter || 'none';
  ctx.globalCompositeOperation = 'lighter';
  try { ctx.filter = 'blur(0.6px)'; } catch(e){ /* ignore */ }

  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.life -= dt;
    if(p.life<=0){ parts.splice(i,1); continue; }
    p.x += p.vx * k;
    p.y += p.vy * k;
    p.vy += 0.02 * k;
    p.alpha = Math.max(0, p.life/700);

    ctx.globalAlpha = p.alpha;
    if(sparkle.complete){
      ctx.drawImage(sparkle, p.x-p.size/2, p.y-p.size/2, p.size, p.size);
    }else{
      ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.arc(p.x,p.y, Math.max(2, p.size*0.15), 0, Math.PI*2); ctx.fill();
    }
  }

  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = prevComp;
  ctx.filter = prevFilter;
  ctx.restore();
}

/* ===== UI render ===== */
function render(){
  balWLD.textContent=wld.toFixed(2); balWLGp.textContent=wlgp.toFixed(3);
  const eMax=capMax(), pct=Math.max(0,Math.min(100,(energy/eMax)*100));
  energyFill.style.width=pct.toFixed(1)+'%'; energyNow.textContent=Math.floor(energy); energyMax.textContent=eMax;

  const cost=priceRefill(); refillPrice.textContent=cost.toFixed(2)+' WLD';
  const low = pct<25, canPay = wld>=cost && energy<eMax-1e-6;
  refillBtn.classList.toggle('pulse', low && canPay);
  refillBtn.disabled = energy>=eMax-1e-6;
  if (typeof renderProfile === 'function') renderProfile();
}

/* ===== Tap logic ===== */
function addTap(){ if(energy<1) return false; energy-=1; wlgp+=POWER_BASE; localStorage.setItem('energy',String(energy)); localStorage.setItem('wlgp',String(wlgp)); return true; }

coin.addEventListener('pointerdown', (e) => {
  // Gate: require World ID verification
  if (!window.isVerified) { tone(220,0.05,'sine',.05); return; }

  lazyRegen();
  const ok = addTap();
  if (ok) {
    // Coordinates relative to #fx
    const rect = fx.getBoundingClientRect();
    let localX = (e.clientX - rect.left)  / (rect.width  || 1) * fx.width;
    let localY = (e.clientY - rect.top)   / (rect.height || 1) * fx.height;

    // Clamp to circle
    const cx = fx.width/2, cy = fx.height/2, r = Math.min(fx.width, fx.height)/2;
    const dx = localX - cx, dy = localY - cy;
    const dist = Math.hypot(dx, dy);
    if (dist > r) { const scale = r/dist; localX = cx + dx*scale; localY = cy + dy*scale; }

    // Move gain to tap point
    if (gain){
      gain.style.left = localX + 'px';
      gain.style.top  = localY + 'px';
      gain.textContent = '+' + POWER_BASE.toFixed(2);
      gain.classList.remove('show'); void gain.offsetWidth; gain.classList.add('show');
    }

    // Spawn particles at tap point
    spawn(localX, localY);

    // Feedback tone and micro scale
    tone(820, 0.05, 'triangle', .07);
    coin.animate(
      [{ transform: 'scale(1)' }, { transform: 'scale(1.06)' }, { transform: 'scale(1)' }],
      { duration: 140, easing: 'ease-out' }
    );
  } else {
    // Out of energy: shake refill button
    refillBtn.classList.add('shake');
    setTimeout(() => refillBtn.classList.remove('shake'), 260);
  }
}, { passive: true });

/* ===== Refill ===== */
async function doRefill(){
  const cost=priceRefill(), eMax=capMax();
  if(energy>=eMax-1e-6) return;
  // Require World ID verification before payment
  if (!window.isVerified){ refillBtn.classList.add('shake'); setTimeout(()=>refillBtn.classList.remove('shake'),260); return; }
  const ok = await worldAppPay({ amount: cost, to: WHITELIST_ADDR, action: 'refill' });
  if(!ok){ refillBtn.classList.add('shake'); setTimeout(()=>refillBtn.classList.remove('shake'),260); return; }
  wld=Math.max(0,wld-cost); energy=eMax; 
  localStorage.setItem('wld',String(wld)); localStorage.setItem('energy',String(energy));
  tone(620,0.08,'sine',.08); render();
}
refillBtn.onclick=()=>{ doRefill(); };

/* ===== Boosters drawer (placeholder) ===== */
const drawerUP=$('#drawerUP'), backdropUP=$('#backdropUP');
const drawerIN=$('#drawerIN'), backdropIN=$('#backdropIN');
const drawerPF=$('#drawerPF'), backdropPF=$('#backdropPF');
const trophyBtn=document.getElementById('trophyBtn'), trophyTip=document.getElementById('trophyTip');
const inboxBtn=document.getElementById('inboxBtn'), unreadBadge=document.getElementById('unreadBadge');
const markRead=document.getElementById('markRead');

function openDrawer(which){
  const map = {
    UP: [drawerUP, backdropUP],
    IN: [drawerIN, backdropIN],
    PF: [drawerPF, backdropPF],
    IDEA: [drawerIDEA, backdropIDEA],
  };
  const pair = map[which];
  if (!pair) return;
  const [dr, bd] = pair;
  dr.classList.add('show');
  bd.classList.add('show');
}
function closeDrawer(which){
  const map = {
    UP: [drawerUP, backdropUP],
    IN: [drawerIN, backdropIN],
    PF: [drawerPF, backdropPF],
    IDEA: [drawerIDEA, backdropIDEA],
  };
  const pair = map[which];
  if (!pair) return;
  const [dr, bd] = pair;
  dr.classList.remove('show');
  bd.classList.remove('show');
}

(function setupTrophyTip(){
  const btn = document.getElementById('trophyBtn');
  const tip = document.getElementById('trophyTip');
  if (!btn || !tip) return;
  let timer;
  btn.addEventListener('click', () => {
    tip.style.opacity = '1'; tip.style.transform = 'translateY(0)';
    clearTimeout(timer);
    timer = setTimeout(()=>{ tip.style.opacity='0'; tip.style.transform='translateY(-6px)'; }, 1100);
  });
})();

/* ===== Idea participation (1.2 WLD) ===== */
const ideaBtn = document.getElementById('ideaBtn');
const ideaPayBtn = document.getElementById('ideaPayBtn');
const ideaSubmitBtn = document.getElementById('ideaSubmitBtn');
const ideaCommentEl = document.getElementById('ideaComment');
const ideaPaidState = document.getElementById('ideaPaidState');
let ideaPaid = (localStorage.getItem('idea_paid') === 'true');

function refreshIdeaUI(){
  if (ideaPaidState) ideaPaidState.textContent = ideaPaid ? 'Paid' : 'Not paid';
  if (ideaSubmitBtn) ideaSubmitBtn.disabled = !ideaPaid;
}
refreshIdeaUI();

if (ideaBtn) ideaBtn.onclick = ()=> openDrawer('IDEA');

if (ideaPayBtn){
  ideaPayBtn.onclick = async () => {
    if (!window.isVerified){ alert('Please verify with World ID first.'); return; }
    const ok = await worldAppPay({ amount: 1.2, to: WHITELIST_ADDR, action: 'idea_participation' });
    if (ok){
      ideaPaid = true; localStorage.setItem('idea_paid','true');
      refreshIdeaUI();
      tone(640,0.05,'sine',.07);
    }
  };
}

if (ideaSubmitBtn){
  ideaSubmitBtn.onclick = () => {
    if (!ideaPaid){ alert('Please pay 1.2 WLD to participate.'); return; }
    const text = (ideaCommentEl?.value || '').trim();
    if (text.length === 0){ alert('Write a short comment.'); return; }
    const all = JSON.parse(localStorage.getItem('idea_comments')||'[]');
    all.push({ t: Date.now(), text });
    localStorage.setItem('idea_comments', JSON.stringify(all));
    ideaCommentEl.value='';
    closeDrawer('IDEA');
  };
}

/* === Inbox estado mínimo === */
let msgs = JSON.parse(localStorage.getItem('msgs') || '[]');
let unread = +localStorage.getItem('unread') || 0;
function saveMsgs(){ localStorage.setItem('msgs', JSON.stringify(msgs)); localStorage.setItem('unread', String(unread)); }
function renderInbox(){
  const box = document.getElementById('inboxList'); if (!box) return;
  const cur = getLang(); const locale = (cur === 'en') ? 'en-US' : 'es-PE'; const T = I18N[cur] || I18N.es;
  if (msgs.length === 0){
    const now = new Date();
    const opts = { timeStyle:'short', dateStyle:'medium' };
    const when = new Intl.DateTimeFormat(locale, opts).format(now);
    msgs = [
      {k:'seed_stay_tuned', ts: now.getTime() },
      {k:'seed_get_wallet', ts: now.getTime() + 1 },
      {k:'seed_farming_time', ts: now.getTime() + 2 },
    ];
    unread = msgs.length; saveMsgs();
  }
  unreadBadge?.classList.toggle('hidden', unread<=0);
  unreadBadge && (unreadBadge.textContent = String(unread));
  box.innerHTML = msgs.map(m=>`<div class="card" style="opacity:.9">${T[m.k]||m.k}</div>`).join('');
}
function markAllRead(){ unread = 0; saveMsgs(); renderInbox(); }
if (markRead) markRead.onclick = markAllRead;

/* ===== Perfil mínimo ===== */
function getLang(){ return localStorage.getItem('lang') || 'en'; }
function setLang(v){ localStorage.setItem('lang', v === 'en' ? 'en' : 'es'); }
var username = localStorage.getItem('username') || 'Player';
function getUsername(){ return localStorage.getItem('username') || 'Player'; }
function setUsername(v){ const s = (v || '').slice(0,20); localStorage.setItem('username', s); username = s; return s; }

function renderLogoGreeting(){
  try{
    const cur = (typeof getLang === 'function') ? getLang() : 'en';
    const hasI18N = typeof I18N !== 'undefined' && I18N && I18N[cur];
    const T = hasI18N ? I18N[cur] : { hello_user: (cur==='en' ? 'Hello {name}!' : 'Hola {name}!') };
    const txt = (T.hello_user || 'Hello {name}!').replace('{name}', getUsername());
    document.querySelector('.logo-text').textContent = txt;
  }catch(e){}
}

/* ===== Render inicial ===== */
function renderProfile(){
  const pf_wld=document.getElementById('pf_wld');
  const pf_wlg=document.getElementById('pf_wlg');
  const pf_wlgp=document.getElementById('pf_wlgp');
  if (pf_wld) pf_wld.textContent = wld.toFixed(2);
  if (pf_wlg) pf_wlg.textContent = '0.00';
  if (pf_wlgp) pf_wlgp.textContent = wlgp.toFixed(3);
}

function loadProfileFields(){
  const usernameInput = document.getElementById('usernameInput');
  const saveBtn = document.getElementById('saveProfile');
  const savedMsg = document.getElementById('savedMsg');
  const langSelect = document.getElementById('langSelect');

  if (usernameInput){
    usernameInput.value = getUsername();
    usernameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        if (saveBtn) saveBtn.click();
      }
    });
  }

  if (saveBtn){
    saveBtn.onclick = () => {
      setUsername(usernameInput.value);
      if (savedMsg){ savedMsg.style.opacity = '1'; setTimeout(()=>savedMsg.style.opacity='0', 650); }
      renderLogoGreeting(); renderProfile();
    };
  }

  if (langSelect){
    langSelect.value = getLang();
    langSelect.onchange = (e)=>{ setLang(e.target.value); applyLang(); };
  }

  renderProfile();
}

/* ===== I18N ===== */
const I18N = {
  es: {
    wld_balance:   'Saldo WLD:',
    coming_soon:   'Próximamente',
    inbox_title:   'Buzón',
    boosters_title:'Impulsores',
    profile_title: 'Perfil',
    mark_read:     'Marcar como leído',
    claim_soon:    'Reclamar (Pronto)',
    demo_title:    'Herramientas de prueba (demo)',
    save:          'Guardar',
    saved:         'Guardado',

    username_label:        'Nombre de usuario',
    username_placeholder:  'Tu nombre',
    option_es:             'Español',
    option_en:             'Inglés',
    profile_wlgp_label:    'WLGp:',
    profile_wlg_label:     'WLG:',
    profile_wld_label:     'WLD:',

    hello_user:            'Hola {name}!',

    seed_stay_tuned:  'Atentos — grandes novedades pronto. ✨',
    seed_get_wallet:  'Ten lista tu wallet para ganar WLD. ✨',
    seed_farming_time:'¡Tiempo de farmear $WLG! Prepárate para el TGE y toma la delantera. 🎮',
  },
  en: {
    wld_balance:   'WLD Balance:',
    coming_soon:   'Coming soon',
    inbox_title:   'Inbox',
    boosters_title:'Boosters',
    profile_title: 'Profile',
    mark_read:     'Mark as read',
    claim_soon:    'Claim (Soon)',
    demo_title:    'Demo tools',
    save:          'Save',
    saved:         'Saved',

    username_label:        'Username',
    username_placeholder:  'Your name',
    option_es:             'Spanish',
    option_en:             'English',
    profile_wlgp_label:    'WLGp:',
    profile_wlg_label:     'WLG:',
    profile_wld_label:     'WLD Balance:',

    hello_user:            'Hello {name}!',

    seed_stay_tuned:  'Stay tuned — big updates soon. ✨',
    seed_get_wallet:  'Get your wallet ready to earn WLD. ✨',
    seed_farming_time:'Farming time for $WLG! Get ready for TGE and take the lead. 🎮',
  }
};

/* Aplica i18n a todos los [data-i18n] y placeholders */
function applyLang(){
  const cur = getLang();
  const T = I18N[cur] || I18N.es;

  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (T[key] != null) el.textContent = T[key];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.getAttribute('data-i18n-placeholder');
    if (T[key] != null) el.setAttribute('placeholder', T[key]);
  });

  document.documentElement.lang = cur;
  if (!localStorage.getItem('lang')) setLang('en');

  renderInbox();
  renderLogoGreeting();
}

/* ===== Boot ===== */
(function boot(){
  try{
    applyLang();
    render();
    loadProfileFields();
    renderInbox();
  }catch(e){
    console.error(e);
  }
})();

</script>
</body>
</html>
