<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>WorldGold — Tap</title>
<meta name="theme-color" content="#1b103a">
<style>
  /* Botón de verificación en splash: vidrio oscuro + acento dorado */
.splash__cta{
  display:inline-flex; align-items:center; justify-content:center; gap:10px;
  margin: 12px auto 6px; padding: 12px 16px; min-height:44px;
  border-radius:14px; font-weight:700; letter-spacing:.3px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,223,120,.28);
  color:#ffd872;
  backdrop-filter: blur(8px);
  transition: transform .15s ease, filter .2s ease, background .2s ease, border-color .2s ease;
}
.splash__cta:hover{ filter: brightness(1.06); }
.splash__cta:active{ transform: translateY(1px) scale(.99); }
.splash__cta:disabled{ opacity:.45; pointer-events:none; filter: grayscale(1) contrast(.9); }

:root{
  --bg1:#6C48FF; --bg2:#1B103A; --ink:#fff; --mut:#C7C4FF;
  --gold:#F4C542; --gold-soft:#FFD872;
  /* MÁS GRANDE y calzada */
  --heroSize: clamp(100px, 82vw, 620px);
  --coinSize: clamp(100px, 82vw, 620px);
}

/* Base */
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;
  /* negro carbón con leve degradado vertical */
  background: linear-gradient(180deg, #0b0b0e 0%, #000 100%);
}

/* Noise overlay (opcional) */
.noise{
  position:fixed; inset:0; pointer-events:none; opacity:0.08; mix-blend-mode:soft-light;
  background-image:url("img/noise-512.png"); background-size:512px 512px; background-repeat:repeat;
  z-index:0;
}

/* Topbar */

.topbar{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:center; height: 60px;
  padding:0 12px;
  background:linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,0)); backdrop-filter:none;
}

.topbar h1{margin:0; font-size:28px}
.top-actions{position:absolute; right:12px; top:calc(8px + env(safe-area-inset-top));z-index:10; font-size:12px; color:var(--mut); text-align:right}

/* Left FABs */
.floatCol{position:fixed; left:12px; top:calc(12px + env(safe-area-inset-top)); z-index:6; display:flex; flex-direction:column; gap:10px}
.fab {
  width:48px; height:48px;
  border:none;
  display:grid; place-items:center;
  background: transparent;
  box-shadow: none;
  cursor:pointer;
  transition: transform 0.2s ease, filter 0.3s ease;
  position: relative;

}

.fab.profile, .fab.trophy, .fab.inbox {
  background: transparent;
  box-shadow: none;
}

.badge{position:absolute;
   top:-6px;
    right:-6px;
     background:#ff3b3b;
      color:#fff;
       border-radius:999px;
        min-width:18px; height:18px;
         display:grid; place-items:center;
          font-size:10px; font-weight:700; padding:0 6px}

/* Hero */
.hero{min-height:calc(100dvh - 76px - env(safe-area-inset-bottom)); display:grid; place-items:center; gap:12px;
  padding:6px 14px calc(24px + env(safe-area-inset-bottom)); position:relative; z-index:1}
.pill{
  z-index:3;
  background: #e0e0e0; border:1px solid #b5b5b5;
  border-radius:999px; padding:8px 16px; font-weight:700; font-size:18px;
  display:inline-flex; align-items:center; gap:10px; backdrop-filter:blur(4px);color: #1a1a1a;
}
.pill img{width:22px; height:22px; display:inline-block}

/* Coin area */
.coinWrap{
  position:relative; width:var(--heroSize); height:var(--heroSize); border-radius:999px; display:grid; place-items:center;
  background:radial-gradient(60% 60% at 50% 40%,#d9d9d9,#5a5a5a 100%);
  box-shadow:0 40px 120px rgba(0,0,0,.35) inset, 0 10px 40px rgba(0,0,0,.25)
}
.ring{position:absolute; inset:0; border-radius:50%;
  box-shadow:
    inset 0 0 0 22px rgba(255,255,255,.03),  /* aro más grueso */
    inset 0 0 0 2px rgba(255,255,255,0.15),
    0 0 25px rgba(255, 230, 150, 0.4),
    0 0 60px rgba(255, 220, 120, 0.25);
}
.coin{
  width:var(--coinSize); height:var(--coinSize); border-radius:999px; display:grid; place-items:center; user-select:none; touch-action:manipulation;
  background:radial-gradient(60% 60% at 50% 40%, #d9d9d9, #5a5a5a 70%);
  border:2px solid rgba(255,255,255,0.15);
  box-shadow:
    0 0 15px rgba(255, 223, 120, 0.7),
    0 0 35px rgba(255, 200, 80, 0.4),
    0 0 60px rgba(255, 180, 60, 0.25);
  transition:transform .08s ease; position:relative; overflow:hidden;
}

.coin:active{transform:scale(.98)}
.coinImg{width:104%; height:109%; display:block; object-fit:cover; pointer-events:none; border-radius: 50%; image-rendering:-webkit-optimize-contrast}
.coinFallback{font-size:52px}
.gain{position:absolute; left:50%; top:44%; transform:translate(-50%,-50%); font-weight:900; font-size:20px; opacity:0; pointer-events:none}
.gain.show{animation:float .6s ease-out forwards}
@keyframes float{from{opacity:0; transform:translate(-50%,-10px) scale(.9)}50%{opacity:1}to{opacity:0; transform:translate(-50%,-40px) scale(1.05)}}
#fx{position:absolute; inset:0; pointer-events:none}

/* Dock (Refill + Booster) debajo de la moneda */
.action-dock{display:flex; align-items:center; justify-content:center; gap:14px; margin-top:12px; z-index:4}
.btn-icon{
  display:flex; align-items:center; gap:10px; min-height:44px; padding:10px 12px;
  background:#b5b5b5; border:1px solid #b5b5b5; border-radius:12px; color:var(--gold-soft);
  backdrop-filter:blur(6px)
}
.btn-icon img{width:34px; height:34px; display:block}
.price-pill{
  font-weight:600; font-size:15px; line-height:20px; color:var(--gold-soft);
  padding:5px 10px; border-radius:10px; background:rgba(10,8,24,.65); border:1px solid rgba(255,255,255,.16)
}
.btn-icon:disabled{opacity:.5; pointer-events:none}
.btn-icon.pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.btn-icon.shake{animation:shake .25s linear}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}}

/* Energy bar */
.energyWrap{width:min(92%,560px); text-align:center; margin-top:16px}
.energyBar{height:16px; background:#231b68; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.12)}
.energyFill{height:100%; background:linear-gradient(90deg,#7c5cff,#bdb3ff); background-size:200% 100%; animation:shimmer 3s linear infinite}
@keyframes shimmer{0%{background-position:0 0}100%{background-position:200% 0}}
.energyLbl{margin-top:6px; font-size:13px; color:var(--mut)}

/* Drawer simple */
.backdrop{position:fixed; inset:0;
   background:rgba(0,0,0,.35);
    opacity:0; pointer-events:none;
     transition:opacity .2s;
      z-index:40}
.backdrop.show{opacity:1; pointer-events:auto}
.drawer{position:fixed; top:0; right:-380px;
   width:min(360px,92vw); height:100dvh;
    background:rgba(10,8,24,.98);
  border-left:1px solid rgba(255,255,255,.1);
   padding:16px 16px calc(24px + env(safe-area-inset-bottom));
    transition:right .28s ease; overflow:auto;
     z-index:60}
.drawer.show{right:0}
.drawer .close{position:sticky; top:0; margin-left:auto; width:34px; height:34px; border-radius:50%; border:1px solid rgba(255,255,255,.25);
  background:transparent; color:#fff; cursor:pointer; font-size:18px}

/* Demo card */
.card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; margin:12px}

/* Ajustes pantallas estrechas */
@media (max-width:360px){
  .btn-icon img{width:28px; height:28px}
  .price-pill{font-size:13px; padding:3px 6px}
  .action-dock{gap:10px}
}/* === Estrellas sutiles === */
.stars, .stars2{
  position: fixed;
  inset: 0;
  pointer-events: none;
  background-repeat: repeat;
  z-index: 0;
}

.stars{
  background-image: radial-gradient(rgba(255,255,255,.30) 2.1px, transparent 1px);
  background-size: 70px 70px;   /* menos densas */
  opacity: .40;                   /* más suave */
  animation: stars-pan 160s linear infinite;
}

.stars2{
  background-image: radial-gradient(rgba(173,216,230,.2) 1.76px, transparent 1px);
  background-size: 30px 30px;     /* un poco más densas que la capa 1 */
  opacity: .30;
  animation: stars-pan 220s linear infinite reverse;
}
@keyframes stars-pan {
  from { background-position: 0 0; }
  to   { background-position: -2000px -1200px; }
}

/* Noise va encima */
.noise{ z-index: 1; }
/* Hover suave dorado en iconos */
.fab img {
  transition: transform 0.25s ease, filter 0.3s ease;
}
.fab:hover img {
  transform: scale(1.15);
  filter: drop-shadow(0 0 6px rgba(255, 223, 120, 0.8));
}
/* Estilo de lista de mensajes (Inbox) */
.inbox-list { display: grid; gap: 10px; }
.msg {
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 12px; padding: 10px;
}
.msg-time { font-size: 12px; color: var(--mut); margin-bottom: 4px; }
.msg-text { white-space: pre-line; line-height: 1.45; }
/* Tooltip del trofeo (limpio y sutil) */
.trophyWrap{
  position: relative;
  display: inline-block;
}
.tip{
  position: absolute;
  right: 0;
  top: -10px;                 /* nace un poco arriba del botón */
  transform: translateY(-6px);
  opacity: 0;
  pointer-events: none;       /* no bloquea clics al botón */
  background: rgba(0,0,0,.85);
  color: #ffd872;
  border: 1px solid rgba(255,223,120,.5);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
  line-height: 1;
  box-shadow: 0 6px 14px rgba(0,0,0,.35);
  transition: opacity .18s ease, transform .18s ease;
  z-index: 999;               /* por encima de todo */
}
.tip::after{
  content: "";
  position: absolute;
  right: 10px;
  top: 100%;
  border: 6px solid transparent;
  border-top-color: rgba(0,0,0,.85); /* flechita */
}
.tip.show{
  opacity: 1;
  transform: translateY(-14px); /* sube un poquito y aparece */
}
/* === Inbox: variantes de mensaje === */
.msg-system{
  border: 1px solid rgba(244, 197, 66, .65);
  background: linear-gradient(180deg, rgba(255,224,150,.10), rgba(0,0,0,.10));
  box-shadow:
     0 0 0 1px rgba(244,197,66,.15) inset,
     0 8px 24px rgba(244,197,66,.12),
     0 0 14px rgba(244,197,66,.25);
}
.msg-system .msg-time{ color: #ffd872; }
/* === OVERRIDE DEL LOGO (pisamos cualquier regla anterior) === */
:root{
  /* Ajusta aquí sin miedo */
  --logoSize: 10px;          /* ej.: 44px, 36px, clamp(28px,5vw,56px) */
  --logoColor: #cf892c;      /* color del texto */
}

/* Más específico + !important para ganar siempre */
.topbar .logo-text{
  font-size: var(--logoSize) !important;
  color: var(--logoColor) !important;
 }
 .logo-text{
  margin: 0;
  font-size: var(--logoSize);
  font-weight: 800;
  color: var(--logoColor);
  letter-spacing: 1.5px;
  text-shadow:
    0 0 3px var(--logoGlow1),
    0 0 6px var(--logoGlow2);
  display: inline-block;
  pointer-events: none;
}
/* === Splash / Pantalla de carga === */
.splash {
  position: fixed; inset: 0; z-index: 9999;           /* por encima de todo */
  display: grid; place-items: center;
  background: radial-gradient(120% 120% at 50% 20%, #0f0f14 0%, #000 70%);
  transition: opacity .36s ease;
  opacity: 1;
  pointer-events: auto;                                /* bloquea la UI detrás */
}

.splash--hide {
  opacity: 0;
  pointer-events: none;                                /* libera la UI al ocultar */
}

.splash__logo {
  width: clamp(140px, 36vw, 220px);   /* más grande que antes */
  height: clamp(140px, 36vw, 220px);
  border-radius: 28px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  display: grid; place-items: center;
  padding: 10px;                      /* menos padding para que la imagen crezca más */
  box-shadow:
    0 16px 40px rgba(0,0,0,.55),
    0 0 28px rgba(255, 220, 120, .18);
  animation: zoom-in 1s ease forwards;
}


@keyframes zoom-in {
  0%   { transform: scale(1.3); opacity: 0; }
  60%  { transform: scale(1.05); opacity: 1; }
  100% { transform: scale(1);   opacity: 1; }
}



.splash__logo img {
  width: 100%; height: 100%; object-fit: contain;
  filter: drop-shadow(0 0 10px rgba(255, 223, 120, .35));
  animation: breathe 3s ease-in-out infinite;
}

/* Animaciones suaves */
@keyframes pop-in { from{ transform: scale(.9); opacity:.0 } to{ transform: scale(1); opacity:1 } }
@keyframes breathe { 0%,100%{ transform: scale(1) } 50%{ transform: scale(1.04) } }

/* Tip extra opcional */
/* Texto del splash con transición simple (sin keyframes) */
.splash__hint {
  margin-top: 16px;
  color: var(--mut);
  font-size: 13px;
  text-align: center;
  opacity: 0;                   /* inicia oculto */
  transform: translateY(6px);   /* pequeño empuje hacia abajo */
  transition: opacity .8s ease, transform .8s ease;
}
/* === Botones pro: loading/success/error y focus visible === */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  min-height: 44px; padding: 10px 14px; gap: 8px;
  border-radius: 12px; border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: #fff; font-weight: 700; cursor: pointer;
  transition: transform .15s ease, filter .2s ease, background .2s ease;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover { filter: brightness(1.05); }
.btn:active { transform: translateY(1px) scale(.99); }
.btn[disabled] { opacity:.55; pointer-events:none; }

/* Variante primaria dorada */
.btn.primary {
  background: linear-gradient(180deg, #F4C542, #CF982C);
  color: #1a1200; border-color: rgba(0,0,0,.15);
  text-shadow: 0 1px 0 rgba(255,255,255,.35);
}

/* Estado loading con spinner */
.btn.is-loading { position: relative; color: transparent !important; }
.btn.is-loading::after{
  content:""; position:absolute; width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(255,255,255,.35); border-top-color:#fff;
  animation: spin 0.8s linear infinite;
}

/* Toast minimal */
.toast {
  position: fixed; left: 50%; bottom: calc(16px + env(safe-area-inset-bottom));
  transform: translateX(-50%); z-index: 9999;
  background: rgba(10,8,24,.92); color: #ffd872;
  border: 1px solid rgba(255,223,120,.45); border-radius: 12px;
  padding: 10px 14px; font-weight: 600; box-shadow: 0 8px 24px rgba(0,0,0,.35);
  opacity: 0; pointer-events: none; transition: opacity .18s ease, transform .18s ease;
}
.toast.show { opacity: 1; pointer-events:auto; transform: translate(-50%, -4px); }

/* Focus accesible */
:focus-visible {
  outline: 2px solid #ffd872;
  outline-offset: 2px;
  border-radius: 12px;
}
/* === Refill tooltip centrado sobre el botón === */
.refillWrap{ position: relative; display: inline-block; }
.refillTip{
  position: absolute;
  left: 50%; top: -10px;
  transform: translate(-50%, -6px);
  opacity: 0; pointer-events: none;
  background: rgba(0,0,0,.85); color: #ffd872;
  border: 1px solid rgba(255,223,120,.5);
  border-radius: 10px; padding: 6px 10px;
  font-size: 12px; line-height: 1;
  box-shadow: 0 6px 14px rgba(0,0,0,.35);
  transition: opacity .18s ease, transform .18s ease;
  z-index: 999;
}
.refillTip::after{
  content:""; position:absolute; left:50%; transform:translateX(-50%);
  top: 100%; border: 6px solid transparent; border-top-color: rgba(0,0,0,.85);
}
.refillTip.show{ opacity: 1; transform: translate(-50%, -14px); }
/* Refill “fantasma”: se ve pero no interactúa (siente que desaparece) */
.btn-icon.ghost{
  opacity: .50 ;
  pointer-events: none;   /* no clickeable */
  filter: grayscale(100%);
  transition: opacity .2s ease, filter .2s ease, transform .2s ease;
}

/* === Spinner para botones .btn-icon === */
@keyframes spin { to { transform: rotate(360deg); } }

.btn-icon.is-loading{
  position: relative;
  pointer-events: none;         /* no clickeable mientras carga */
  opacity: .9;                  /* leve atenuación */
}

.btn-icon.is-loading::after{
  content: "";
  position: absolute;
  top: 50%; left: 50%;
  width: 20px; height: 20px;
  margin: -10px 0 0 -10px;      /* centra el spinner */
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,.35);
  border-top-color: #fff;       /* “punta” blanca */
  animation: spin .8s linear infinite;
  filter: drop-shadow(0 0 4px rgba(255,223,120,.6));
}

/* Opcional: baja un poco el contenido mientras carga */
.btn-icon.is-loading img,
.btn-icon.is-loading .price-pill{ opacity: .25; }



</style>
</head>
<body>
  <!-- === SPLASH / CARGA INICIAL === -->
<div id="splash" class="splash" aria-busy="true" aria-label="Cargando WorldGold">
  <div class="splash__logo">
    <!-- Usa tu logo existente en /img -->
    <!-- Sugerido: brand-mark-wg-128.png (incluido en tu proyecto) -->
    <img src="img/logo-splash.png" alt="WorldGold" onerror="this.style.display='none'">
  </div>
  <!-- CTA de verificación -->
<button id="splashVerifyBtn" class="splash__cta" data-i18n="verify_human">
  Verificar con World ID
</button>

  <div class="splash__hint">Preparando tu sesión...</div>
</div>

  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="noise" aria-hidden="true"></div>
<!-- Left FABs -->
<div class="floatCol">
  <button id="profileBtn" class="fab profile" title="Profile">
    <img src="img/icon-profile.png" alt="Perfil" style="width:45px;height:45px;">
  </button>
  <button id="inboxBtn" class="fab inbox" title="Inbox">
    <img src="img/icon-inbox.png" alt="Inbox" style="width:35px;height:35px;">
    <span id="inboxBadge" class="badge" style="display:none">0</span>
  </button>
</div>

<!-- Topbar -->
<div class="topbar">
  <h1 class="logo-text"></h1>
</div>

<!-- Botón trofeo en top-actions -->
<div class="top-actions" style="overflow:visible">
  <div><span data-i18n="wld_balance">Saldo WLD:</span></div>
  <div><b id="balWLD">0.00</b> WLD</div>

  <!-- WRAP del trofeo: el tip vive junto al botón -->
  <div class="trophyWrap">
    <button id="trophyBtn" class="fab trophy" title="Leaderboard" type="button" aria-describedby="trophyTip">
      <img src="img/icon-trophy.png" alt="Trophy" style="width:25px;height:25px;">
    </button>
    <div id="trophyTip" class="tip" data-i18n="coming_soon">Próximamente</div>
  </div>
</div>




<!-- HERO -->
<section class="hero">
  <div class="pill">
    <img src="img/brand-mark-wg-128.png" alt="" onerror="this.style.display='none'">
    WLGp: <b id="balWLGp">0.000</b>
    
  </div>

  <div class="coinWrap" id="coinBox">
    <div class="ring"></div>
    <canvas id="fx"></canvas>
    <div id="coin" class="coin" aria-label="Tap">
      <img src="img/Coin.png" alt="" class="coinImg" onerror="this.remove();
      document.getElementById('fallback').style.display='block'">
      <div id="fallback" class="coinFallback" style="display:none">🪙</div>
      <div id="gain" class="gain">+0.40</div>
    </div>
  </div>
 
  <!-- DOCK bajo la moneda -->
  <div class="action-dock" aria-label="acciones rápidas">
    <!-- WRAP para el refill + tip -->
  <div class="refillWrap">
    <button id="refillBtn" class="btn-icon" aria-label="Refill">
      <img src="img/ico-refill.png" alt="Refill" style="width:40px;height:40px;">
      <span id="refillPrice" class="price-pill">0.10 WLD</span>
    </button>
    <!-- 👇 Tooltip oculto que aparece cuando recargas -->
    <div id="refillTip" class="refillTip" data-i18n="energy_full">Energía recargada</div>
  </div>
    <button id="openUp" class="btn btn-icon" aria-label="Boosters">
      <img src="img/icon-gear.png" alt="Perfil" style="width:40px;height:35px;">
    </button>
  </div>

  <div class="energyWrap">
    <div class="energyBar"><div id="energyFill" class="energyFill" style="width:100%"></div></div>
    <div class="energyLbl">⚡ <b id="energyNow">100</b>/<b id="energyMax">100</b></div>
  </div>
</section>

<!-- Drawers (Boosters simple + Inbox placeholder+Perfil) -->
<div id="backdropUP" class="backdrop"></div>
<aside id="drawerUP" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('UP')">x</button>
  <h3 data-i18n="boosters_title">Impulsores</h3>
  <p style="opacity:.85">Any ideas what this could be?</p>
</aside>


<div id="backdropIN" class="backdrop"></div>
<aside id="drawerIN" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('IN')">x</button>
<h3 data-i18n="inbox_title" style="margin:0 0 8px">Buzón</h3>
<div id="inboxList" class="inbox-list"></div>
<button id="markRead" class="btn btn-icon" data-i18n="mark_read">Marcar como leído</button>
</aside>
<!-- Drawer Perfil -->
<div id="backdropPF" class="backdrop"></div>
<aside id="drawerPF" class="drawer" role="dialog" aria-modal="true">
  <button class="close" aria-label="Cerrar" onclick="closeDrawer('PF')">x</button>
  <h3 data-i18n="profile_title" style="margin:0 0 12px">Perfil</h3>

<label data-i18n="username_label" style="display:block;margin-bottom:8px;font-size:14px;">Nombre de usuario</label>
<input id="usernameInput" type="text"
  style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;"
  data-i18n-placeholder="username_placeholder"
  placeholder="Tu nombre">

<div id="saveRow" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
  <button id="saveUsernameBtn" class="btn btn-icon" style="min-height:auto;padding:6px 10px;display:none" data-i18n="save">Guardar</button>
  <span id="savedBadge" style="display:none;font-size:12px;color:#ffd872;">✓ <span data-i18n="saved">Guardado</span></span>
</div>

<label data-i18n="language_label" style="display:block;margin:16px 0 8px;font-size:14px;">Idioma</label>
<select id="langSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff;">
  <option value="es" data-i18n="option_es">Español</option>
  <option value="en" data-i18n="option_en">Inglés</option>
</select>

<div style="margin:16px 0;">
  <p><span data-i18n="profile_wlgp_label">WLGp:</span> <b id="profWLGp">0.000</b></p>
  <p style="opacity:.7;"><span data-i18n="profile_wlg_label">WLG Balance:</span> <b id="profWLG">--</b> 🔒</p>
  <p style="opacity:.7;"><span data-i18n="profile_wld_label">WLD Balance:</span> <b id="profWLD">--</b> 🔒</p>
</div>
<!-- Verificación de humano (World ID) -->
<button id="verifyBtn" class="btn primary" style="width:100%;margin:8px 0" data-i18n="verify_human">
  Verificar humano
</button>

<button id="claimBtn" class="btn-icon" disabled style="opacity:.5;" data-i18n="claim_soon">Reclamar (Pronto)</button>

</aside>


<!-- Demo tools -->
<section class="card">
  <h3 id="demoTitle" data-i18n="demo_title" style="margin:0 0 8px">Herramientas de prueba (demo)</h3>
  <div style="display:flex;gap:10px;justify-content:flex-end">
    <button id="btnAddWLD">+5 WLD</button>
    <button id="btnReset">Reset</button>
  </div>
</section>

<script>
  // === Bandera de demo ===
const DEMO_ENABLED = true; // ⚠️ cambia a false en producción

(function toggleDemo(){
  const title = document.getElementById('demoTitle');
  if (!title) return;
  const card = title.closest('section');
  if (!card) return;
  card.style.display = DEMO_ENABLED ? '' : 'none';
})();
(function splashController(){
  const splash = document.getElementById('splash');
  if (!splash) return;
  const hint = splash.querySelector('.splash__hint');
  const btn  = document.getElementById('splashVerifyBtn');

  let hidden = false;
  const hide = () => {
    if (hidden) return;
    hidden = true;
    splash.setAttribute('aria-busy', 'false');
    splash.classList.add('splash--hide');
    setTimeout(()=> splash.remove(), 450); // limpia tras el fade-out
  };

  // Tiempos (ajústalos si quieres más/menos duración):
  const READY_DELAY = 900;              // mostrar "Preparando..." después del logo
  const DONE_DELAY  = READY_DELAY + 900; // cambiar a "¡Listo!" luego de 0.9s
  const HIDE_DELAY  = DONE_DELAY + 500;  // ocultar splash 0.5s después

  // Safety por si algo raro pasa (mejor 5s que 4s para asegurar ver el hint)
  const safetyTimer = setTimeout(hide, 5000);

  // ⬇️ Reemplazo completo del onload
  window.addEventListener('load', () => {
    let hidden = false;
    const hide = () => {
      if (hidden) return; hidden = true;
      splash.setAttribute('aria-busy','false');
      splash.classList.add('splash--hide');
      setTimeout(()=> splash.remove(), 450);
    };

    // Estado inicial
    if (hint) hint.textContent = 'Preparando tu sesión…';

    // Si ya verificó en esta sesión, no pedimos nada
    const already = sessionStorage.getItem('wlg_verified') === '1';
    if (already){
      if (hint) hint.textContent = '¡Listo!';
      setTimeout(hide, 500);
      return;
    }

    // Requerimos verificación para entrar (gateo)
    if (btn){
      btn.addEventListener('click', async () => {
        const out = await window.__WLG.verifyOnDemand(hint, btn);
        if (out.ok){
          setTimeout(hide, 500); // cerrar suave tras “¡Listo!”
        }else{
          // Canceló o error: mantenemos el splash y el botón visible
          // Puedes mostrar un mensaje visual si quieres:
          // showToast('Necesitas verificar para continuar');
        }
      }, { passive:true });
    }else{
      // Plan B: si por algún motivo no está el botón, no bloqueamos al usuario.
      if (hint) hint.textContent = '¡Listo!';
      setTimeout(hide, 600);
    }
  });
})();
/* ===== Helpers ===== */
const $=q=>document.querySelector(q);
let AC; function tone(f=560,d=.05,t='triangle',v=.08){try{AC=AC||new (window.AudioContext||window.webkitAudioContext)();const o=AC.createOscillator(),g=AC.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g).connect(AC.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+d);o.stop(AC.currentTime+d+0.02);}catch(e){}}

/* ===== Estado base (demo) ===== */
const BASE_CAP=100, BASE_REGEN_PER_SEC=0.8, POWER_BASE=0.40;
let wld = +localStorage.getItem('wld') || 0;
let wlgp= +localStorage.getItem('wlgp')|| 0;
let energy=+localStorage.getItem('energy'); if(isNaN(energy)) energy=BASE_CAP;
let lastTs=+localStorage.getItem('last_ts')||Date.now();

/* ===== Derivados ===== */
function capMax(){return BASE_CAP}
function regenPerSec(){return BASE_REGEN_PER_SEC}
function priceRefill(){return +(capMax()/1000).toFixed(2)} // 0.1% capacidad
function lazyRegen(){const now=Date.now(),dt=(now-lastTs)/1000;lastTs=now;energy=Math.min(capMax(),energy+regenPerSec()*dt);localStorage.setItem('last_ts',String(lastTs));localStorage.setItem('energy',String(energy));}

/* ===== Refs ===== */
const balWLD=$('#balWLD'), balWLGp=$('#balWLGp');
const coin=$('#coin'), gain=$('#gain');
const fx=$('#fx'), ctx=fx.getContext('2d');
const energyFill=$('#energyFill'), energyNow=$('#energyNow'), energyMax=$('#energyMax');
const refillBtn=$('#refillBtn'), refillPrice=$('#refillPrice');
const openUp=$('#openUp'), drawerUP=$('#drawerUP'), backdropUP=$('#backdropUP');
const inboxBtn=$('#inboxBtn'), drawerIN=$('#drawerIN'), backdropIN=$('#backdropIN'), inboxBadge=$('#inboxBadge');
const profileBtn=$('#profileBtn'), drawerPF=$('#drawerPF'), backdropPF=$('#backdropPF');
const btnAddWLD=$('#btnAddWLD'), btnReset=$('#btnReset');
// ===== Inbox: estado y render =====
let msgs = JSON.parse(localStorage.getItem('msgs') || '[]');
let unread = +localStorage.getItem('unread') || 0;

function saveMsgs(){
  localStorage.setItem('msgs', JSON.stringify(msgs));
  localStorage.setItem('unread', String(unread));
}

function renderInbox(){
  const box = document.getElementById('inboxList');
  if (!box) return;

  const cur = getLang();
  const locale = (cur === 'en') ? 'en-US' : 'es-PE';
  const T = I18N[cur] || I18N.es;

  if (msgs.length === 0){
    // "Sin mensajes" también se traduce:
    box.innerHTML = '';
    const p = document.createElement('p');
    p.style.opacity = '.7';
    p.textContent = (cur === 'en') ? 'No messages.' : 'Sin mensajes.';
    box.appendChild(p);
  } else {
    box.innerHTML = '';
    msgs.forEach(m => {
      const wrap = document.createElement('div');
      wrap.className = 'msg' + (m.type === 'system' ? ' msg-system' : '');

      const time = document.createElement('div');
      time.className = 'msg-time';
      time.textContent = new Date(m.ts).toLocaleString(locale);

      const txt = document.createElement('div');
      txt.className = 'msg-text';

      // Si el mensaje tiene "key", se traduce; si no, usa el texto literal
      if (m.key && T[m.key] != null){
        txt.textContent = T[m.key];
      } else {
        txt.textContent = String(m.text || '');
      }

      wrap.appendChild(time);
      wrap.appendChild(txt);
      box.appendChild(wrap);
    });
  }

  if (unread > 0){
    inboxBadge.style.display = 'grid';
    inboxBadge.textContent = unread;
  } else {
    inboxBadge.style.display = 'none';
  }
}

// Mensaje con TEXTO literal (no se traduce al cambiar idioma)
function addMessage(text, type='announce'){
  const allowed = new Set(['system','announce','reward']);
  if (!allowed.has(type)) return;
  msgs.unshift({ text: String(text || ''), ts: Date.now(), type });
  unread++;
  saveMsgs();
  renderInbox();
}

// Mensaje por CLAVE del diccionario (sí se traduce al cambiar idioma)
function addMessageKey(key, type='announce'){
  const allowed = new Set(['system','announce','reward']);
  if (!allowed.has(type)) return;
  msgs.unshift({ key: String(key || ''), ts: Date.now(), type });
  unread++;
  saveMsgs();
  renderInbox();
}

// Abrir Inbox = mostrar y limpiar contador
if (inboxBtn) inboxBtn.onclick = () => {
  openDrawer('IN');
  unread = 0;
  saveMsgs();
  renderInbox();
};

// Botón "Marcar como leído"
const markRead = document.getElementById('markRead');
if (markRead) markRead.onclick = () => {
  unread = 0;
  saveMsgs();
  renderInbox();
};

/* ===== Canvas del tamaño de la moneda ===== */
function sizeCanvasToCoin(){
  const r = coin.getBoundingClientRect();
  const scale = window.devicePixelRatio || 1;
  fx.width  = Math.round(r.width * scale);
  fx.height = Math.round(r.height * scale);
  fx.style.width  = r.width + 'px';
  fx.style.height = r.height + 'px';
}
addEventListener('resize', sizeCanvasToCoin);

/* ===== Partículas con fallback ===== */
const sparkle = new Image(); sparkle.src = 'img/sparkle.png' ;
let parts=[];
function spawn(x,y){for(let i=0;i<14;i++){const a=Math.random()*Math.PI*2, sp=1.5+Math.random()*2.2, s=16+Math.random()*10;
  parts.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:600+Math.random()*400,size:s,alpha:1});}}
function stepFX(dt){
  ctx.clearRect(0,0,fx.width,fx.height);
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i]; p.life-=dt; if(p.life<=0){parts.splice(i,1); continue;}
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.alpha=Math.max(0,p.life/700);
    ctx.globalAlpha=p.alpha;
    if(sparkle.complete){
      ctx.drawImage(sparkle, p.x-p.size/2, p.y-p.size/2, p.size, p.size);
    }else{
      ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.arc(p.x,p.y, Math.max(2, p.size*0.15), 0, Math.PI*2); ctx.fill();
    }
  }
  ctx.globalAlpha=1;
}

/* ===== UI render ===== */
function render(){
  balWLD.textContent = wld.toFixed(2);
  balWLGp.textContent = wlgp.toFixed(3);

  const eMax = capMax();
  const pct  = Math.max(0, Math.min(100, (energy / eMax) * 100));
  energyFill.style.width = pct.toFixed(1) + '%';
  energyNow.textContent = Math.floor(energy);
  energyMax.textContent = eMax;

  const cost   = priceRefill();
  refillPrice.textContent = cost.toFixed(2) + ' WLD';

  const eMaxed = energy >= eMax - 1e-6;  // energía llena
  const canPay = wld >= cost;            // saldo suficiente

  // 1) Nunca ocultamos el botón
  refillBtn.style.display = 'flex';

  // 2) Estado fantasma si NO hay WLD y aún falta energía
  const needsEnergy = !eMaxed;
  const ghost = needsEnergy && !canPay;
  refillBtn.classList.toggle('ghost', ghost);

  // 3) Pulse solo cuando puede pagar y falta energía
  const pulse = needsEnergy && canPay;
  refillBtn.classList.toggle('pulse', pulse);

  // 4) Deshabilitado cuando está al máximo (se ve, pero no clickea)
  refillBtn.disabled = eMaxed;

  if (typeof renderProfile === 'function') renderProfile();
}




/* ===== Tap logic ===== */
function addTap(){ if(energy<1) return false; energy-=1; wlgp+=POWER_BASE; localStorage.setItem('energy',String(energy)); localStorage.setItem('wlgp',String(wlgp)); return true; }
/* ===== Tap logic (pointerdown para mejor respuesta en WebView) ===== */
(function setupTap(){
  let lastTap = 0;
  function handleTap(e){
    e.preventDefault?.();
    lazyRegen();
    const ok = addTap();
    if (ok){
      gain.textContent = `+${POWER_BASE.toFixed(2)}`;
      gain.classList.remove('show'); void gain.offsetWidth; gain.classList.add('show');
      tone(820,0.05,'triangle',.07);
      // Partículas en el punto de toque
      const rect = fx.getBoundingClientRect();
      const clientX = e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? rect.left + rect.width/2;
      const clientY = e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? rect.top  + rect.height/2;
      const x = (clientX - rect.left)/(rect.width||1)*fx.width;
      const y = (clientY - rect.top )/(rect.height||1)*fx.height;
      spawn(x,y);
      coin.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:140,easing:'ease-out'});
    }else{
      refillBtn.classList.add('shake'); setTimeout(()=>refillBtn.classList.remove('shake'),260);
    }
    render();
    lastTap = performance.now();
  }

  // Limpia listeners previos de click si existieran (defensivo)
  coin.replaceWith(coin.cloneNode(true));
  const coin2 = document.getElementById('coin');

  coin2.addEventListener('pointerdown', handleTap, { passive: true });
  // Por compatibilidad si pointer no está disponible:
  coin2.addEventListener('touchstart', handleTap, { passive: true });
  coin2.addEventListener('mousedown', handleTap);
})();
/* === Tooltip de refill (muestra y auto-oculta) === */
function showRefillTip(){
  const tip = document.getElementById('refillTip');
  if (!tip) return;
  // Texto según idioma
  const cur = (typeof getLang === 'function') ? getLang() : 'es';
  const T = (typeof I18N !== 'undefined' && I18N[cur]) ? I18N[cur] : { energy_full: 'Energía recargada' };
  tip.textContent = T.energy_full || 'Energía recargada';

  tip.classList.add('show');
  clearTimeout(tip._t);
  tip._t = setTimeout(()=> tip.classList.remove('show'), 1600);
}

/* ===== Refill ===== */
function doRefill(){
  const cost=priceRefill(), eMax=capMax();
  if(energy>=eMax-1e-6) return;

  // Si NO alcanza WLD: NO recarga, NO mensaje de éxito, solo shake
  if(wld<cost){
    refillBtn.classList.add('shake');
    setTimeout(()=>refillBtn.classList.remove('shake'),260);
    return;
  }

  // ÉXITO: descuenta, recarga, renderiza y muestra tooltip
  wld-=cost; energy=eMax;
  localStorage.setItem('wld',String(wld));
  localStorage.setItem('energy',String(energy));
  tone(620,0.08,'sine',.08);
  render();
  showRefillTip(); // 👈 solo aquí (éxito)
}

// Helper que muestra el spinner del botón durante la acción
function withLoading(btn, fn){
  return async function(...args){
    btn.classList.add('is-loading');
    btn.setAttribute('aria-busy','true');
    try{
      // Si doRefill es síncrona, igual dejamos el spinner unos ms para que se vea
      const maybePromise = fn.apply(this, args);
      await Promise.resolve(maybePromise);
    } finally {
      // Mantenemos el spinner un instante para que el usuario lo perciba
      setTimeout(()=>{
        btn.classList.remove('is-loading');
        btn.removeAttribute('aria-busy');
      }, 450);
    }
  }
}

// Usamos el wrapper en lugar de asignar la función directa
refillBtn.onclick = withLoading(refillBtn, doRefill);



/* ===== Boosters drawer (placeholder) ===== */
openUp.onclick=()=>openDrawer('UP');

function openDrawer(which){
  const map = {
    UP: [drawerUP, backdropUP],
    IN: [drawerIN, backdropIN],
    PF: [drawerPF, backdropPF],
  };
  const pair = map[which];
  if (!pair) return;
  const [dr, bd] = pair;
  dr.classList.add('show');
  bd.classList.add('show');
}
function closeDrawer(which){
  const map = {
    UP: [drawerUP, backdropUP],
    IN: [drawerIN, backdropIN],
    PF: [drawerPF, backdropPF],
  };
  const pair = map[which];
  if (!pair) return;
  const [dr, bd] = pair;
  dr.classList.remove('show');
  bd.classList.remove('show');
}

/* Cerrar tocando el fondo */
if (backdropUP) backdropUP.onclick = () => closeDrawer('UP');
if (backdropIN) backdropIN.onclick = () => closeDrawer('IN');
if (backdropPF) backdropPF.onclick = () => closeDrawer('PF');

/* === Clicks de Perfil e Inbox (no volver a declarar profileBtn/inboxBtn) === */
if (profileBtn) profileBtn.onclick = () => openDrawer('PF');




// === Demo buttons (handlers seguros) ===
const addWldBtn = document.getElementById('btnAddWLD');
if (addWldBtn) {
  addWldBtn.addEventListener('click', () => {
    wld += 5;                                   // suma 5 WLD
    localStorage.setItem('wld', String(wld));   // persiste
    render();                                   // refresca balances/energía
    if (typeof renderProfile === 'function') renderProfile(); // sincroniza Perfil
  });
}

const resetBtn = document.getElementById('btnReset');
if (resetBtn) {
  resetBtn.addEventListener('click', () => {
    if (confirm('¿Reiniciar demo?')) {
      localStorage.clear();
      location.reload();
    }
  });
}

/* ===== Main loop (FX + regeneración visible) ===== */
let tPrev = performance.now();
function frame(t){
  const dt = t - tPrev; tPrev = t;
  stepFX(dt);             // partículas/sombras
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

// Regeneración y UI cada 250 ms (sube 1 en 1 a su ritmo)
const REGEN_UI_MS = 250;
setInterval(() => {
  lazyRegen();            // calcula energía con tiempo real
  render();               // actualiza barra y números
}, REGEN_UI_MS);


/* ===== Perfil: nombre de usuario + idioma ===== */
/* Helpers sin TDZ */
function getLang(){ return localStorage.getItem('lang') || 'es'; }
function setLang(v){ localStorage.setItem('lang', v === 'en' ? 'en' : 'es'); }

var username = localStorage.getItem('username') || 'Player'; // por compatibilidad con otros trozos
function getUsername(){ return localStorage.getItem('username') || 'Player'; }
function setUsername(v){
  const s = (v || '').slice(0,20);
  localStorage.setItem('username', s);
  username = s;
  return s;
}

// === Saludo en el logo (NIVEL RAÍZ, fuera de cualquier función) ===
function renderLogoGreeting(){
  try{
    const cur = (typeof getLang === 'function') ? getLang() : 'es';
    const hasI18N = typeof I18N !== 'undefined' && I18N && I18N[cur];
    const T = hasI18N ? I18N[cur] : { hello_user: (cur==='en' ? 'Hello {name}!' : 'Hola {name}!') };
    const user = (typeof getUsername === 'function') ? getUsername() : 'Player';
    const h1 = document.querySelector('.logo-text');
    if (!h1) return;
    const text = (T.hello_user || (cur==='en' ? 'Hello {name}!' : 'Hola {name}!')).replace('{name}', user || 'Player');
    h1.textContent = text;
  }catch(e){ console.error('[greeting] error:', e); }
}


/* Diccionario i18n (UNA sola vez) */
/* Diccionario i18n (UNA sola vez) */
const I18N = {
  es: {
    wld_balance:   'Saldo WLD:',
    coming_soon:   'Próximamente',
    inbox_title:   'Buzón',
    boosters_title:'Impulsores',
    profile_title: 'Perfil',
    mark_read:     'Marcar como leído',
    claim_soon:    'Reclamar (Pronto)',
    demo_title:    'Herramientas de prueba (demo)',
    save:          'Guardar',
    saved:         'Guardado',

    // 👇 NUEVO: Perfil
    username_label:        'Nombre de usuario',
    username_placeholder:  'Tu nombre',
    language_label:        'Idioma',
    option_es:             'Español',
    option_en:             'Inglés',
    profile_wlgp_label:    'WLGp:',
    profile_wlg_label:     'WLG Balance:',
    profile_wld_label:     'WLD Balance:',

    // 👇 Saludo del logo
    hello_user:            'Hola {name}!',

    // 👇 Seeds del Inbox (si usas addMessageKey)
    seed_stay_tuned:  'Novedades MUY pronto. Mantente atento. ✨',
    seed_get_wallet:  'Prepara tu billetera para ganar WLD. ✨',
    seed_farming_time:'¡Hora de farmear $WLG! Alístate para el TGE y toma la delantera. 🎮',
    energy_full: '⚡ Energía 100%',
    verify_human: 'Verificar humano',
  },
  en: {
    wld_balance:   'WLD Balance:',
    coming_soon:   'Coming Soon',
    inbox_title:   'Inbox',
    boosters_title:'Boosters',
    profile_title: 'Profile',
    mark_read:     'Mark as read',
    claim_soon:    'Claim (Soon)',
    demo_title:    'Demo tools',
    save:          'Save',
    saved:         'Saved',

    // 👇 NEW: Profile
    username_label:        'Username',
    username_placeholder:  'Your name',
    language_label:        'Language',
    option_es:             'Spanish',
    option_en:             'English',
    profile_wlgp_label:    'WLGp:',
    profile_wlg_label:     'WLG Balance:',
    profile_wld_label:     'WLD Balance:',

    // 👇 Logo greeting
    hello_user:            'Hello {name}!',

    // 👇 Inbox seeds
    seed_stay_tuned:  'Stay tuned — big updates soon. ✨',
    seed_get_wallet:  'Get your wallet ready to earn WLD. ✨',
    seed_farming_time:'Farming time for $WLG! Get ready for TGE and take the lead. 🎮',
    energy_full: '⚡ Energy 100%',
    verify_human: 'Verify Human',
  }
};


/* Aplica i18n a todos los [data-i18n] */
/* Aplica i18n a todos los [data-i18n] y placeholders */
function applyLang(){
  const cur = getLang();
  const T = I18N[cur] || I18N.es;

  // 1) Textos
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (T[key] != null) el.textContent = T[key];
  });

  // 2) Placeholders (inputs/textarea)
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.getAttribute('data-i18n-placeholder');
    if (T[key] != null) el.setAttribute('placeholder', T[key]);
  });

  document.documentElement.lang = cur;

  // Redibuja partes dependientes de idioma
  renderInbox();                         // Inbox por clave
  if (typeof renderLogoGreeting === 'function') renderLogoGreeting(); // Hola/Hello {name}
}



/* Carga campos del Perfil + botón Guardar */
function loadProfileFields(){
  const usernameInput = document.getElementById('usernameInput');
  const saveBtn       = document.getElementById('saveUsernameBtn');
  const savedBadge    = document.getElementById('savedBadge');
  const langSelect    = document.getElementById('langSelect');

  // Nombre de usuario
  if (usernameInput){
    usernameInput.value = getUsername();

    const markDirty = ()=>{
      const dirty = usernameInput.value !== getUsername();
      if (saveBtn)   saveBtn.style.display   = dirty ? 'inline-flex' : 'none';
      if (savedBadge) savedBadge.style.display = 'none';
    };
    usernameInput.addEventListener('input', markDirty);
    usernameInput.addEventListener('focus', markDirty);

    if (saveBtn){
      saveBtn.onclick = ()=>{
  const normalized = setUsername(usernameInput.value);
  usernameInput.value = normalized;
  saveBtn.style.display = 'none';
  if (savedBadge){
    savedBadge.style.display = 'inline';
    clearTimeout(savedBadge._t);
    savedBadge._t = setTimeout(()=> savedBadge.style.display = 'none', 1200);
  }
  if (typeof renderLogoGreeting === 'function') renderLogoGreeting(); // una sola vez
};

    }
    // Auto-guardar al salir del input
    usernameInput.addEventListener('blur', ()=>{
      if (usernameInput.value !== getUsername()){
        if (saveBtn) saveBtn.click();
      }
    });
  }

  // Idioma
  if (langSelect){
    langSelect.value = getLang();
    langSelect.onchange = (e)=>{
      setLang(e.target.value);
      applyLang();
    };
  }

  // Primera aplicación
  applyLang();
}

/* Muestra balances dentro del Perfil */
function renderProfile(){
  const pWLD  = document.getElementById('profWLD');
  const pWLGp = document.getElementById('profWLGp');
  if (pWLD)  pWLD.textContent  = wld.toFixed(2);
  if (pWLGp) pWLGp.textContent = wlgp.toFixed(3);
}



/* ===== Init ===== */
(function init(){
  sizeCanvasToCoin();
  // Partículas de arranque para confirmar que se ven
  setTimeout(()=>{ spawn(fx.width/2, fx.height/2); }, 250);

  render();               // primer pintado
  loadProfileFields();    // engancha Perfil (username/idioma)
  if (typeof renderProfile === 'function') renderProfile(); // sincroniza WLD/WLGp en Perfil
  // Mensajes iniciales con CLAVE (se traducen)
if (msgs.length === 0) {
  addMessageKey('seed_stay_tuned', 'system');
  addMessageKey('seed_get_wallet', 'system');
  addMessageKey('seed_farming_time', 'system');
}

// Primer pintado del Inbox (ahora sí, I18N ya existe)
renderInbox();
renderLogoGreeting(); // pinta "Hola Fer!" (o Hello)


})(); // 👈 MUY IMPORTANTE: cerrar la IIFE


</script>
<script>
(function setupTrophyTip(){
  const btn = document.getElementById('trophyBtn');
  const tip = document.getElementById('trophyTip');
  if (!btn || !tip) return;

  let timer;
  btn.addEventListener('click', () => {
    tip.classList.add('show');     // aparece
    clearTimeout(timer);
    timer = setTimeout(() => {
      tip.classList.remove('show'); // se desvanece
    }, 1600); // 1.6s visible
  });
})();
</script>
<script>
// === Feature flag: activa pagos reales cuando conectes la Action de World App ===
const PAYMENTS_ENABLED = false; // TODO: pon true cuando termines el whitelisting

// === Adaptador de pagos: reemplaza aquí por tu integración real ===
const Payments = {
  /**
   * Simula una compra de "refill" por cost WLD.
   * Cuando tengas tu actionId y address whitelisted:
   * - Llama al SDK/bridge de World App aquí.
   * - Valida recibo/tx y resuelve si fue éxito, rechaza si falla.
   */
  async buyRefill({ costWLD, timeoutMs = 12000 }) {
    if (!PAYMENTS_ENABLED) {
      // Modo demo: “paga” sin red
      await new Promise(r => setTimeout(r, 600)); // pequeña espera
      return { ok: true, txId: "demo-local" };
    }
    // TODO: integrar SDK real
    // Ejemplo de estructura (pseudocódigo):
    // return await world.pay({actionId, to: address, amount: costWLD});
    return new Promise((resolve, reject) => {
      const t = setTimeout(() => reject(new Error("timeout")), timeoutMs);
      // Elimina esto cuando integres el real:
      setTimeout(() => { clearTimeout(t); resolve({ ok:true, txId:"stub" }); }, 1200);
    });
  }
};

// === Toast utilitario ===
function showToast(msg, ms = 1800) {
  const n = document.createElement('div');
  n.className = 'toast'; n.textContent = msg;
  n.setAttribute('role','status'); n.setAttribute('aria-live','polite');
  document.body.appendChild(n);
  requestAnimationFrame(() => n.classList.add('show'));
  setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 220); }, ms);
}

// === Re-wire del Refill: pagar -> aplicar refill local ===
(function enhanceRefill(){
  const btn = document.getElementById('refillBtn');
  if (!btn) return;

  // Reutilizamos tu cálculo de precio global:
  const getCost = () => typeof priceRefill === 'function' ? priceRefill() : 0.10;

  async function onRefillClick(){
    // Si ya está al máximo, conserva tu lógica:
    if (typeof capMax === 'function'
     && typeof energy !== 'undefined'
     && energy >= capMax() - 1e-6) {
      return;
    }

    // Loading on
    btn.classList.add('is-loading');
    btn.setAttribute('disabled','true');

    try {
      const cost = getCost();
      const res = await Payments.buyRefill({ costWLD: cost });
      if (!res || !res.ok) throw new Error('payment_failed');

      // Aplicamos tu refill local (reutilizamos tu doRefill sin restar WLD si ya lo hará el backend):
      if (typeof doRefill === 'function') {
        // TEMP: evitamos doble descuento en demo (tu doRefill descuenta local)
        doRefill();
      } else {
        // Fallback mínimo si alguien borró doRefill:
        if (typeof capMax === 'function') {
          energy = capMax();
          if (typeof render === 'function') render();
        }
      }

    } catch (e) {
      // Feedback de error y sacudida suave
      btn.classList.add('shake');
      setTimeout(()=>btn.classList.remove('shake'), 260);
      showToast('❌ No se pudo completar el pago');
    } finally {
      // Loading off
      btn.classList.remove('is-loading');
      btn.removeAttribute('disabled');
    }
  }

  // Reemplaza handler existente solo para pagos (seguimos usando tu doRefill internamente)
  btn.onclick = onRefillClick;
})();
</script>
<script type="module">
  import { MiniKit, VerificationLevel } 
    from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.9.6/+esm";

  // TODO: reemplaza por tu Incognito Action real desde el Developer Portal
  const ACTION_ID = "your-action-id";

  const isWorldApp = () => MiniKit.isInstalled();
  const showToast = window.showToast || (msg => console.log('[toast]', msg));

  // Exponemos utilidades globales para que el controlador del splash las use
  window.__WLG = {
    async verifyOnDemand(hintEl, btnEl){
      if (!isWorldApp()){
        showToast('Ábrelo dentro de World App para verificar');
        return { ok:false, reason:'not_worldapp' };
      }
      try{
        if (btnEl) btnEl.disabled = true;
        if (hintEl) hintEl.textContent = 'Verificando con World ID…';

        const { finalPayload } = await MiniKit.commandsAsync.verify({
          action: ACTION_ID,
          verification_level: VerificationLevel.Orb,
        });

        if (finalPayload?.status === 'success'){
          // (Recomendado) Enviar al backend para validación real:
          // await fetch('/api/verify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ payload: finalPayload, action: ACTION_ID }) });
          sessionStorage.setItem('wlg_verified','1');
          if (hintEl) hintEl.textContent = '¡Listo!';
          return { ok:true };
        }
        if (hintEl) hintEl.textContent = 'Preparando tu sesión…';
        if (btnEl) btnEl.disabled = false;
        return { ok:false, reason:'cancelled' };
      }catch(e){
        console.error(e);
        if (hintEl) hintEl.textContent = 'Preparando tu sesión…';
        if (btnEl) btnEl.disabled = false;
        showToast('❌ Error al verificar, reintenta');
        return { ok:false, reason:'error' };
      }
    }
  };
</script>


</body>
</html>
